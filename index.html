<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cổng Tác Vụ NCTN 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#C41E3A',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #C41E3A;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#C41E3A 0%,#EF4444 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(196,30,58,.15);color:#7f1d1d;border:1px solid rgba(196,30,58,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#C41E3A 0%,#EF4444 100%);box-shadow:0 4px 6px rgba(196,30,58,.1),0 1px 3px rgba(196,30,58,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(196,30,58,.12),0 3px 6px rgba(196,30,58,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Form 2: Tab styling */
    .f2-panel{transition:all .2s ease}
    .f2-panel.hidden{display:none}
    /* Form 2: Table styling */
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .cell-div{ border-left:1px solid #e5e7eb; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside class="w-64 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-red-200 mb-4">Cổng Tác Vụ NCTN 2</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form1">Form 1 · Tra cứu tác vụ</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form2">Form 2 · Tất cả tác vụ</button>
      <!-- <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form4">Form 4 · Bảng theo dõi </button> -->
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-10 flex flex-col items-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Phòng NCTN 2</div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">Cổng tác vụ NCTN 2 - Nội bộ</h2>
        <p class="text-red-100 text-sm md:text-base">Vui lòng không chia sẻ link cổng tác vụ với người ngoài bộ phận.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-red-800">Form 1 · Tra cứu tác vụ</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
            <button id="f1-unassigned" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Chưa phân công</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để gửi yêu cầu và hiển thị tác vụ</p>
        </div>
        <div class="md:col-span-2">
          <div class="flex items-center gap-3">
            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Lọc theo tháng:</label>
            <select id="f1-month" class="w-40 border border-red-300 rounded-lg bg-slate-100 p-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
              <option value="">— Tất cả tháng —</option>
            </select>
            <button id="f1-clear-filter" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Xóa lọc</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Các tác vụ Doing sẽ luôn hiện lên đầu và không bị lọc theo tháng</p>
        </div>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1760px] w-full text-sm">
          <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px]">Trả báo cáo</th>
              <th class="px-3 py-2 min-w-[140px]">Tình trạng</th>
              <th class="px-3 py-2 min-w-[160px]">Ngày hoàn thành thực tế</th>
              <th class="px-3 py-2 min-w-[140px]">Mã</th>
              <th class="px-3 py-2 min-w-[260px]">Tên tác vụ</th>
              <th class="px-3 py-2 min-w-[160px]">Người yêu cầu</th>
              <th class="px-3 py-2 min-w-[120px]">Công chuẩn</th>
              <th class="px-3 py-2 min-w-[140px]">Ngày yêu cầu</th>
              <th class="px-3 py-2 min-w-[140px]">Hạn mong muốn</th>
              <th class="px-3 py-2 min-w-[140px]">Hạn đáp ứng</th>
              <th class="px-3 py-2 min-w-[260px]">Mục đích đánh giá</th>
              <th class="px-3 py-2 min-w-[240px]">Note</th>
              <th class="px-3 py-2 min-w-[240px]">Yêu cầu test đặc biệt</th>
              <th class="px-3 py-2 min-w-[260px]">Form báo cáo đánh giá</th>
              <th class="px-3 py-2 min-w-[220px]">Tên file đính kèm</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 dòng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hiển thị</label>
          <select id="f1-size" class="border border-red-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Trước</button>
          <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>

      <!-- Điểm lưu trữ file đính kèm -->
      <div class="mt-4">
        <a id="f1-storage-link" href="https://drive.google.com/drive/u/0/folders/1iVSNn6Ddv6jEun6lyMvOMcan2fpnFSpU" target="_blank" rel="noopener" title="Nhấn để mở và tự động copy liên kết"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-red-200 bg-red-50/30 text-primary-blue hover:bg-red-50">
          Điểm lưu trữ file đính kèm
        </a>
        <p class="text-xs text-gray-500 mt-1">Nhấn để mở và copy liên kết.</p>
      </div>
    </section>

    <!-- Form 2 · Tất cả tác vụ -->
    <section id="form2" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-red-800">Form 2 · Tất cả tác vụ</h2>
        <div class="flex items-center gap-2">
          <button id="f2-export" class="px-3 py-1 rounded-lg border border-red-300 text-primary-blue bg-red-50 hover:bg-red-100">Xuất server</button>
          <button id="f2-export-xlsx" class="px-3 py-1 rounded-lg border border-red-300 text-primary-blue bg-red-50 hover:bg-red-100">Xuất XLSX</button>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f2-month" type="month" class="border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white"/>
        </div>
        <!-- P1 Header -->
        <div class="mt-2 flex items-center gap-2 border-b border-gray-200">
          <div class="px-4 py-2 font-semibold text-red-800 bg-red-50 rounded-t-lg border-b-2 border-red-200">Thống kê tiến độ</div>
        </div>
        <!-- Thẻ P1: Thống kê tiến độ -->
        <div id="f2-panel-p1" class="f2-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-red-50 to-white flex items-center justify-center">
            <span class="font-semibold text-red-800 mr-4">Thẻ - Thống kê tiến độ</span>
            <button id="f2-search-p1" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra cứu</button>
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
          <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nhân viên</th>
              <th class="px-3 py-2">Tổng tác vụ đang thực hiện</th>
              <th class="px-3 py-2">Số Done trong tháng</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Số N/A</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
              <th class="px-3 py-2">%N/A</th>
            </tr>
          </thead>
            <tbody id="f2-body-p1" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-red-50 to-white border-b border-gray-200">
        <h3 id="upload-title" class="text-base font-semibold text-gray-800">Gửi báo cáo</h3>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200">Người nộp: <b class="ml-1" id="uploader-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200">Mã: <b class="ml-1" id="uploader-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200">Tác vụ: <b class="ml-1" id="uploader-task"></b></span>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tệp báo cáo</label>
          <input id="upload-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <p class="text-xs text-gray-500 mt-1">Tệp sẽ gửi kèm timestamp tại thời điểm gửi.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú (tùy chọn)</label>
          <textarea id="upload-note" rows="3" placeholder="Nhập ghi chú về báo cáo..." class="w-full border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white"></textarea>
          <p class="text-xs text-gray-500 mt-1">Ghi chú sẽ được gửi kèm với báo cáo.</p>
        </div>
        <div id="bps-option" class="flex items-center gap-2" style="display:none">
          <input id="upload-bps" type="checkbox" class="h-4 w-4">
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Trả báo cáo BPS</label>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Huỷ</button>
        <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Gửi báo cáo</button>
      </div>
    </div>
  </div>

  <!-- Modal: Chi tiết tác vụ theo nhân viên (Form 2 P1) -->
  <div id="f2-p1-detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f2-p1-detail-title">
    <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
      <div class="px-4 py-3 bg-gradient-to-b from-red-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="f2-p1-detail-title" class="text-base font-semibold text-gray-800">Chi tiết tác vụ của <span id="f2-p1-detail-name" class="text-primary-blue"></span></h3>
        <button id="f2-p1-detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[1200px] w-full text-sm">
            <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2 min-w-[140px]">Tình trạng</th>
                <th class="px-3 py-2 min-w-[160px]">Ngày hoàn thành thực tế</th>
                <th class="px-3 py-2 min-w-[140px]">Mã</th>
                <th class="px-3 py-2 min-w-[260px]">Tên tác vụ</th>
                <th class="px-3 py-2 min-w-[160px]">Người yêu cầu</th>
                <th class="px-3 py-2 min-w-[140px]">Ngày yêu cầu</th>
                <th class="px-3 py-2 min-w-[140px]">Hạn mong muốn</th>
                <th class="px-3 py-2 min-w-[240px]">Note</th>
              </tr>
            </thead>
            <tbody id="f2-p1-detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="w-full max-w-5xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-red-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="detail-title" class="text-base font-semibold text-gray-800">Nhiệm vụ của <span id="detail-name" class="text-primary-blue"></span></h3>
        <button id="detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Mã</th>
                <th class="px-3 py-2">Tên tác vụ</th>
                <th class="px-3 py-2">Trạng thái</th>
                <th class="px-3 py-2">Công chuẩn</th>
                <th class="px-3 py-2">Ngày yêu cầu</th>
                <th class="px-3 py-2">Hạn mong muốn</th>
                <th class="px-3 py-2">Hạn đáp ứng</th>
                <th class="px-3 py-2">Ngày hoàn thành</th>
              </tr>
            </thead>
            <tbody id="detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
      </div>
    </div>
  </div>


  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://xcqiyibqs.tino.page/webhook/tracuutacvuNCTN2";
    const FORM2_WEBHOOK_URL = "https://xcqiyibqs.tino.page/webhook/Tracuutongtacvu";
    const FORM1_UPLOAD_URL = "https://xcqiyibqs.tino.page/webhook/TrabaocaoNTCN2";
    let F4_CHART = null;

    // Hàm format timestamp theo định dạng DD HH:mm GMT+7
    function formatTimestampGMT7() {
      const now = new Date();
      // Chuyển đổi sang GMT+7 (UTC+7)
      const gmt7 = new Date(now.getTime() + (7 * 60 * 60 * 1000));
      
      const year = gmt7.getUTCFullYear();
      const month = String(gmt7.getUTCMonth() + 1).padStart(2, '0');
      const day = String(gmt7.getUTCDate()).padStart(2, '0');
      const hours = String(gmt7.getUTCHours()).padStart(2, '0');
      const minutes = String(gmt7.getUTCMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1', 'form2'].map(id=>document.getElementById(id));
    function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        const target = btn.getAttribute('data-target');
        showSection(target);
        
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Names - Form 1
    const FORM1_NAMES = [
      "Trần Văn Hoàng",
      "Nguyễn Kim Cương",
      "Trịnh Xuân Hạnh",
      "Đỗ Xuân Huy",
      "Giang Văn Toàn",
      "Vũ Ngọc Diệp",
      "Bùi Ngọc Hùng",
      "Nhân Viên Mới 1",
      "Nhân Viên Mới 2",
    ];

    // Names - Form 2 (NCTN 2) - Danh sách riêng biệt
    const FORM2_NAMES = [
      "Trần Văn Hoàng",
      "Nguyễn Kim Cương", 
      "Trịnh Xuân Hạnh",
      "Đỗ Xuân Huy",
      "Giang Văn Toàn",
      "Vũ Ngọc Diệp",
      "Bùi Ngọc Hùng",
      "Nhân Viên Mới 1",
      "Nhân Viên Mới 2",
    ];
    

    // Dữ liệu tác vụ (khởi tạo rỗng; sẽ nối nguồn thật sau)
    const demoTasksForm1 = {};
    

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);

    // Fill month dropdown
    function fillMonthSelect(){
      const monthSelect = document.getElementById('f1-month');
      if (!monthSelect) return;
      
      const months = [];
      const now = new Date();
      
      // Tạo danh sách 12 tháng gần nhất (bao gồm tháng hiện tại)
      for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthName = date.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' });
        const value = `${year}-${month}`;
        months.push({ value, text: monthName });
      }
      
      months.forEach(m => {
        const option = document.createElement('option');
        option.value = m.value;
        option.textContent = m.text;
        monthSelect.appendChild(option);
      });
    }
    fillMonthSelect();

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Upload modal
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Người nộp pill no longer needed (Form 2 removed)
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = 'none';
        if (bpsCheckbox) bpsCheckbox.checked = false;
      } catch(_) {}
      fileInput.value = '';
      const noteInput = document.getElementById('upload-note');
      if (noteInput) noteInput.value = '';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Gửi báo cáo';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui lòng chọn tệp báo cáo.','error'); return; }
      const btn = document.getElementById('btn-send');
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', formatTimestampGMT7());
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        fd.append('ma_tac_vu', uploadContext.code||'');
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      const noteInput = document.getElementById('upload-note');
      const noteValue = noteInput ? (noteInput.value || '').trim() : '';
      fd.append('note', noteValue);
      fd.append('ghi_chu', noteValue);
      const bpsCheckbox = document.getElementById('upload-bps');
      fd.append('is_bps', '0');
      const targetUpload = FORM1_UPLOAD_URL;
      try{
        await fetch(targetUpload,{method:'POST',body:fd});
        showToast('Đã gửi báo cáo.','success');
        closeUploadModal();
      }
      catch(e){
        console.error(e);
        showToast('Gửi thất bại.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
      }
    };

    // Helpers for tables
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-2 align-top'; td.textContent=text; tr.appendChild(td); }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 10;
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Không có tác vụ</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} dòng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    let F1_UNASSIGNED_MODE = false;
    let F1_MONTH_FILTER = '';
    let F1_ALL_DATA = []; // Lưu tất cả dữ liệu gốc để lọc cục bộ

    // Hàm lọc cục bộ theo tháng
    function applyLocalMonthFilter() {
      if (!F1_ALL_DATA.length) return;
      
      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      let filteredData = [...F1_ALL_DATA];

      // Lọc theo tháng nếu có bộ lọc
      if (F1_MONTH_FILTER) {
        filteredData = filteredData.filter(item => {
          const statusText = String(getV(item, ['status', 'trangthai', 'trang_thai', 'trạng thái']) || '').toLowerCase();
          const isDoing = statusText.includes('doing') || statusText.includes('đang');
          
          // Tác vụ Doing luôn hiển thị (không bị lọc theo tháng)
          // Nhưng vẫn phải tuân theo lọc tên (đã được lọc từ server)
          if (isDoing) return true;
          
          // Các tác vụ khác lọc theo tháng
          const requestDate = getV(item, ['requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ngày yêu cầu']);
          if (!requestDate) return false;
          
          const date = new Date(requestDate);
          if (isNaN(date.getTime())) return false;
          
          const itemYear = date.getFullYear();
          const itemMonth = String(date.getMonth() + 1).padStart(2, '0');
          const itemMonthStr = `${itemYear}-${itemMonth}`;
          
          return itemMonthStr === F1_MONTH_FILTER;
        });
      }

      // Sắp xếp: Doing trước, sau đó theo thời gian từ gần đến xa
      filteredData.sort((a, b) => {
        const statusA = String(getV(a, ['status', 'trangthai', 'trang_thai', 'trạng thái']) || '').toLowerCase();
        const statusB = String(getV(b, ['status', 'trangthai', 'trang_thai', 'trạng thái']) || '').toLowerCase();
        
        const isDoingA = statusA.includes('doing') || statusA.includes('đang');
        const isDoingB = statusB.includes('doing') || statusB.includes('đang');
        
        // Ưu tiên Doing trước
        if (isDoingA && !isDoingB) return -1;
        if (!isDoingA && isDoingB) return 1;
        
        // Nếu cùng trạng thái, sắp xếp theo thời gian từ gần đến xa
        const getRequestDate = (item) => {
          const requestDate = getV(item, ['requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ngày yêu cầu']);
          if (!requestDate) return new Date(0); // Nếu không có ngày, đặt ở cuối
          
          const date = new Date(requestDate);
          return isNaN(date.getTime()) ? new Date(0) : date;
        };
        
        const dateA = getRequestDate(a);
        const dateB = getRequestDate(b);
        
        // Sắp xếp từ gần đến xa (mới nhất lên đầu)
        return dateB.getTime() - dateA.getTime();
      });

      // Render lại bảng với dữ liệu đã lọc
      renderFilteredData(filteredData);
    }

    // Hàm render dữ liệu đã lọc
    function renderFilteredData(data) {
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      
      if (!data.length) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Không có tác vụ</td></tr>';
        pager.style.display = 'none';
        return;
      }

      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      const nameSelected = (document.getElementById('f1-name').value || '').trim();

      F1_ALL_ROWS = [];
      data.forEach(item => {
        const tr = document.createElement('tr');
        const tdBtn = document.createElement('td'); 
        tdBtn.className = 'px-3 py-2';
        
        const code = getV(item, ['Mã tác vụ', 'code', 'ma', 'taskcode', 'mã']);
        const tname = getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 'tên tác vụ']);
        
        // Tạo nút Trả báo cáo - chỉ cho phép khi trạng thái Doing
        const statusText = getV(item, ['⁉️ Kết quả', 'Hiện trạng', 'status', 'trangthai', 'trang_thai', 'trạng thái']);
        const statusLower = (statusText || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        const isEmptyStatus = statusLower.trim() === '';
        const isLocked = !isDoing; // Chỉ cho phép khi Doing

        const labelBtn = document.createElement('label');
        if (isLocked) {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60 pointer-events-none';
          if (isCancelled) {
            labelBtn.textContent = 'Đã hủy';
          } else if (isDone) {
            labelBtn.textContent = 'Đã hoàn thành';
          } else if (isEmptyStatus) {
            labelBtn.textContent = 'Trạng thái trống';
          } else {
            labelBtn.textContent = 'Chỉ Doing mới được gửi';
          }
        } else {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
          labelBtn.textContent = 'Trả báo cáo';
          labelBtn.onclick = (e) => {
            e.preventDefault();
            if (labelBtn.disabled) return;
            labelBtn.disabled = true;
            labelBtn.classList.add('opacity-50', 'pointer-events-none');
            lastOpenTrigger = labelBtn;
            openUploadModal({ form: 'Form 1', name: nameSelected, code, taskName: tname });
          };
        }
        
        tdBtn.appendChild(labelBtn);
        tr.appendChild(tdBtn);

        // Các cột khác
        const tdStatus = document.createElement('td'); 
        tdStatus.className = 'px-3 py-2';
        const s = (statusText || '').toLowerCase();
        const badge = document.createElement('span'); 
        badge.className = 'px-2 py-1 rounded text-xs ' + (s.includes('hoàn') || s.includes('done')
          ? 'bg-green-100 text-green-800'
          : (s.includes('cancel') || s.includes('hủy') || s.includes('huỷ') || s.includes('chờ') || s.includes('pending'))
            ? 'bg-yellow-100 text-yellow-800'
            : 'bg-blue-100 text-blue-800');
        badge.textContent = statusText || ''; 
        tdStatus.appendChild(badge); 
        tr.appendChild(tdStatus);

        // Thêm cột Ngày hoàn thành thực tế
        addTd(tr, getV(item, ['Ngày hoàn thành thực tế', 'completiondate', 'completeddate', 'ngayhoanthanh', 'ngay_hoan_thanh', 'completion', 'done_date', 'ngày hoàn thành']));

        addTd(tr, code);
        addTd(tr, tname);
        addTd(tr, getV(item, ['🖊️ Tên NCC ', 'requester', 'nguoiyeucau', 'nguoi_yeu_cau', 'assigner', 'người yêu cầu']));
        addTd(tr, getV(item, ['Công chuẩn công việc nhận tuần 22', 'manhour', 'man_hour', 'congchuan', 'cong_chuan', 'workload', 'sogio', 'sogiocong', 'công chuẩn']));
        addTd(tr, getV(item, ['📆 Ngày yêu cầu ', 'requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ngày yêu cầu']));
        addTd(tr, getV(item, ['Hạn mong muốn ', 'wishdue', 'hanmongmuon', 'han_mong_muon', 'desireddue', 'hạn mong muốn']));
        addTd(tr, getV(item, ['actualdue', 'handapung', 'han_dap_ung', 'completiondate', 'hạn đáp ứng']));
        addTd(tr, getV(item, ['❓ Mục đích đánh giá ', 'purpose', 'mucdich', 'muc_dich', 'mục đích đánh giá', 'muc dich danh gia', 'mucdichdanhgia']));
        addTd(tr, getV(item, ['note', 'ghi_chu', 'ghichu']));
        addTd(tr, getV(item, ['specialtest', 'yeucau_test_dac_biet', 'yeu_cau_test_dac_biet']));
        addTd(tr, getV(item, ['reportform', 'form_bao_cao', 'form_bao_cao_danh_gia']));
        addTd(tr, getV(item, ['attachmentfilename', 'file_name', 'filename', 'tenfile', 'ten_file', 'tên file', 'tên file đính kèm', 'attachment', 'file']));

        // Highlight theo hạn mong muốn cho tác vụ Doing
        try {
          const wishDueStr = getV(item, ['Hạn mong muốn ', 'wishdue', 'hanmongmuon', 'han_mong_muon', 'desireddue', 'hạn mong muốn']);
          if (isDoing && wishDueStr) {
            const dueDate = parseDateFlexible(wishDueStr);
            if (!isNaN(dueDate.getTime())) {
              const ymd = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
              const today = new Date();
              const dueYmd = ymd(dueDate);
              const todayYmd = ymd(today);
              if (dueYmd < todayYmd) {
                tr.style.backgroundColor = '#FEE2E2'; // đỏ nhạt
              } else if (dueYmd === todayYmd) {
                tr.style.backgroundColor = '#FEF3C7'; // vàng nhạt
              }
            }
          }
        } catch(_) {}

        F1_ALL_ROWS.push(tr);
      });

      applyForm1Paging();
    }

    function fetchWithTimeout(resource, options = {}){
      const { timeout = 120000 } = options;
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(()=>clearTimeout(id));
    }

    async function renderForm1(){
      const unassigned = F1_UNASSIGNED_MODE === true;
      const nameSelected = (document.getElementById('f1-name').value || '').trim();
      const personParam = unassigned ? '' : nameSelected;
      const body = document.getElementById('f1-body');
      if(!unassigned && !nameSelected){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'Nút nhập gửi báo cáo',
          header_requester: 'Người yêu cầu',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_code: 'Mã',
          header_taskName: 'Tên tác vụ',
            header_manHour: 'Công chuẩn',
          header_purpose: 'Mục đích đánh giá',
          header_note: 'Note',
          header_specialTest: 'Yêu cầu test đặc biệt',
          header_reportForm: 'Form báo cáo đánh giá',
          header_status: 'Trạng thái',
          header_completionDate: 'Ngày hoàn thành thực tế',
          header_attachmentFileName: 'Tên file đính kèm',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
            field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_completionDate: 'completionDate',
          field_attachmentFileName: 'attachmentFileName'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: personParam,
          timestamp: formatTimestampGMT7()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          // Retry nhẹ: tối đa 2 lần khi lỗi mạng/timeout
          const maxAttempts = 2;
          let lastErr = null;
          for (let attempt = 1; attempt <= maxAttempts; attempt++){
            try{
              const r = await fetchWithTimeout(url, { 
                method: 'GET', 
                timeout: 120000,
                mode: 'cors',
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Content-Type': 'application/json'
                }
              });
              const text = await r.text();
              if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
              let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
              return { parsed, raw: text };
            }catch(e){
              lastErr = e;
              if (attempt < maxAttempts) {
                // chờ ngắn trước lần thử tiếp
                await new Promise(res=>setTimeout(res, 1000));
                continue;
              }
              throw lastErr;
            }
          }
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook chưa bật lắng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          try {
            const { parsed, raw } = await fetchJson(prodUrl);
            data = parsed ?? raw;
          } catch (e2) {
            // Nếu cả hai đều fail, thử với proxy CORS
            console.log('[Form1 Debug] Direct fetch failed, trying CORS proxy');
            const proxyUrls = [
              `https://api.allorigins.win/raw?url=${encodeURIComponent(prodUrl)}`,
              `https://cors.isomorphic-git.org/${prodUrl}`,
              `https://cors-anywhere.herokuapp.com/${prodUrl}`,
              `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(prodUrl)}`
            ];
            
            for (const proxyUrl of proxyUrls) {
              try {
                console.log('[Form1 Debug] Trying proxy:', proxyUrl);
                const { parsed, raw } = await fetchJson(proxyUrl);
                data = parsed ?? raw;
                break;
              } catch (e3) {
                console.log('[Form1 Debug] Proxy failed:', e3.message);
                continue;
              }
            }
            
            if (!data) {
              throw e2; // Throw original error if all proxies fail
            }
          }
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        let rows = pickRows(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // Lọc bỏ các dòng không có Tên tác vụ (tránh rỗng thông tin)
        rows = rows.filter(item=> String(getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ'])||'').trim() !== '');
        if(!rows.length){ body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
        
        // Lưu dữ liệu gốc để lọc cục bộ
        F1_ALL_DATA = [...rows];
        
        // Áp dụng lọc cục bộ
        applyLocalMonthFilter();
      }catch(err){
        const isCors = /Failed to fetch|CORS|No 'Access-Control-Allow-Origin'|NetworkError|TypeError/.test(String(err && (err.message || err)));
        const msg = isCors
          ? 'Bị chặn bởi CORS. Đã thử nhiều proxy nhưng vẫn không thể kết nối. Vui lòng mở file qua web server (vd: Live Server) hoặc kiểm tra kết nối mạng.'
          : (String(err && err.name)==='AbortError') ? 'Quá thời gian chờ (120s). Vui lòng thử lại.' : `Lỗi tải dữ liệu: ${String(err.message||err)}`;
        body.innerHTML = `<tr><td colspan='15' class='px-3 py-3 text-center text-red-600'>${msg}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { F1_UNASSIGNED_MODE = false; await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // Nút lọc các tác vụ chưa được phân công (tên trống)
    const f1UnassignedBtn = document.getElementById('f1-unassigned');
    if (f1UnassignedBtn) {
      let f1UBusy = false;
      f1UnassignedBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1UBusy) return;
        f1UBusy = true;
        F1_UNASSIGNED_MODE = true;
        f1UnassignedBtn.disabled = true;
        const prev = f1UnassignedBtn.textContent;
        f1UnassignedBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm1(); }
        finally {
          f1UBusy = false;
          f1UnassignedBtn.disabled = false;
          f1UnassignedBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'10',10)||10; F1_PAGE=1; applyForm1Paging(); };

    // Month filter events - chỉ lọc cục bộ, không gọi server
    const f1Month = document.getElementById('f1-month');
    const f1ClearFilter = document.getElementById('f1-clear-filter');
    
    if (f1Month) {
      f1Month.addEventListener('change', (e) => {
        F1_MONTH_FILTER = e.target.value || '';
        F1_PAGE = 1; // Reset về trang đầu khi thay đổi bộ lọc
        applyLocalMonthFilter(); // Chỉ lọc cục bộ
      });
    }
    
    if (f1ClearFilter) {
      f1ClearFilter.addEventListener('click', (e) => {
        e.preventDefault();
        F1_MONTH_FILTER = '';
        if (f1Month) f1Month.value = '';
        F1_PAGE = 1; // Reset về trang đầu khi xóa bộ lọc
        applyLocalMonthFilter(); // Chỉ lọc cục bộ
      });
    }




    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('Đã copy liên kết.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }

    // ===== Form 2: Tất cả tác vụ =====
    let F2_ALL_DATA = [];
    let F2_MONTH_FILTER = '';
    let F2_EMPLOYEE_STATS = {}; // Lưu thống kê theo nhân viên

    // Form 2: Month filter
    const f2Month = document.getElementById('f2-month');
    if (f2Month) {
      // Set default month to current month
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      f2Month.value = `${year}-${month}`;
      F2_MONTH_FILTER = f2Month.value;

      f2Month.addEventListener('change', (e) => {
        F2_MONTH_FILTER = e.target.value || '';
        console.log('[Form2 Debug] Month changed to:', F2_MONTH_FILTER);
        console.log('[Form2 Debug] F2_ALL_DATA length:', F2_ALL_DATA.length);
        // Dùng dữ liệu hiện có, không gọi lại server
        if (F2_ALL_DATA.length > 0) {
          calculateEmployeeStats(F2_ALL_DATA);
          renderForm2Stats();
          console.log('[Form2 Debug] Stats recalculated and rendered');
        } else {
          console.log('[Form2 Debug] No data available for recalculation');
        }
      });
    }

    // Form 2: Fetch data from same source as Form 1
    async function fetchForm2Data() {
      const body = document.getElementById('f2-body-p1');
      if (!body) return;

      body.innerHTML = "<tr><td colspan='10' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";

      try {
        const headerMapF2 = {
          // Headers cho modal (15 cột)
          header_btn: 'Nút nhập gửi báo cáo',
          header_status: 'Tình trạng',
          header_completionDate: 'Ngày hoàn thành thực tế',
          header_code: 'Mã',
          header_taskName: 'Tên tác vụ',
          header_requester: 'Người yêu cầu',
          header_manHour: 'Công chuẩn',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_purpose: 'Mục đích đánh giá',
          header_note: 'Note',
          header_specialTest: 'Yêu cầu test đặc biệt',
          header_reportForm: 'Form báo cáo đánh giá',
          header_attachmentFileName: 'Tên file đính kèm',
          
          // Field mappings cho modal
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
          field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_completionDate: 'completionDate',
          field_attachmentFileName: 'attachmentFileName',
          
          // Additional fields for comprehensive data
          field_assignee: 'assignee',
          field_progress: 'progress',
          field_priority: 'priority',
          field_category: 'category',
          field_department: 'department',
          field_project: 'project',
          field_estimatedHours: 'estimatedHours',
          field_actualHours: 'actualHours',
          field_createdDate: 'createdDate',
          field_updatedDate: 'updatedDate',
          field_createdBy: 'createdBy',
          field_updatedBy: 'updatedBy',
          field_tags: 'tags',
          field_comments: 'comments',
          field_attachments: 'attachments',
          field_relatedTasks: 'relatedTasks',
          field_dependencies: 'dependencies',
          field_riskLevel: 'riskLevel',
          field_complexity: 'complexity',
          field_qualityScore: 'qualityScore',
          field_feedback: 'feedback',
          field_lessonsLearned: 'lessonsLearned',
          field_nextSteps: 'nextSteps',
          field_resources: 'resources',
          field_tools: 'tools',
          field_methodology: 'methodology',
          field_standards: 'standards',
          field_compliance: 'compliance',
          field_approvalStatus: 'approvalStatus',
          field_approver: 'approver',
          field_approvalDate: 'approvalDate',
          field_reviewStatus: 'reviewStatus',
          field_reviewer: 'reviewer',
          field_reviewDate: 'reviewDate',
          field_testStatus: 'testStatus',
          field_tester: 'tester',
          field_testDate: 'testDate',
          field_deploymentStatus: 'deploymentStatus',
          field_deploymentDate: 'deploymentDate',
          field_performance: 'performance',
          field_metrics: 'metrics',
          field_kpis: 'kpis',
          field_sla: 'sla',
          field_budget: 'budget',
          field_cost: 'cost',
          field_roi: 'roi',
          field_impact: 'impact',
          field_benefits: 'benefits',
          field_challenges: 'challenges',
          field_solutions: 'solutions',
          field_recommendations: 'recommendations'
        };

        // Lấy tên người hiện tại (có thể từ Form 1 hoặc mặc định)
        const currentPersonName = (document.getElementById('f1-name')?.value || '').trim() || 'Tất cả';
        
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_all_tasks', // Action riêng cho Form 2
          person_name: currentPersonName, // Thêm tên người vào query
          month: F2_MONTH_FILTER || '',
          timestamp: formatTimestampGMT7()
        });

        const baseUrl = `${FORM2_WEBHOOK_URL}?${params.toString()}`;

        async function fetchJsonWithProxyChain(base) {
        // Thử JSONP trước (hoạt động với file://)
        const jsonpPromise = new Promise((resolve, reject) => {
          const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
          const script = document.createElement('script');
          const url = base + (base.includes('?') ? '&' : '?') + 'callback=' + callbackName;
          
          window[callbackName] = function(data) {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve({ parsed: data, source: 'jsonp' });
          };
          
          script.onerror = function() {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('JSONP_FAILED'));
          };
          
          script.src = url;
          document.head.appendChild(script);
          
          // Timeout sau 30 giây
          setTimeout(() => {
            if (document.head.contains(script)) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('JSONP_TIMEOUT'));
            }
          }, 30000);
        });

        try {
          console.log('[Form2 Debug] Trying JSONP:', base);
          const result = await jsonpPromise;
          if (result.parsed && hasMeaningfulRows(result.parsed)) {
            return result;
          }
        } catch (e) {
          console.log('[Form2 Debug] JSONP failed:', e.message);
        }

        // Fallback: Thử fetch trực tiếp như Form 5
        const urlProd = base.includes('/webhook/') ? base : base.replace('/webhook-test/', '/webhook/');
        const urlTest = base.includes('/webhook-test/') ? base : base.replace('/webhook/', '/webhook-test/');
        const urls = [urlTest, urlProd];
        
        let lastErr = null;
        const hasMeaningfulRows = (obj)=>{
          if (Array.isArray(obj)) return obj.length > 0 && typeof obj[0] === 'object';
          if (!obj || typeof obj !== 'object') return false;
          const keys = ['data','rows','result','records','items','list'];
          for (const k of keys) {
            const v = obj[k];
            if (Array.isArray(v) && v.length && typeof v[0] === 'object') return true;
          }
          try {
            for (const v of Object.values(obj)) {
              if (Array.isArray(v) && v.length && typeof v[0] === 'object') return true;
            }
          } catch(_){}
          return false;
        };

        for (const url of urls) {
          try {
            console.log('[Form2 Debug] Fetching:', url);
            const r = await fetch(url, { 
              method: 'GET',
              headers: {
                'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json'
              }
            });
            const text = await r.text();
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
            if (!text || text.trim().length === 0) throw new Error('EMPTY_RESPONSE');
            
            let parsed = null;
            try { parsed = JSON.parse(text); } catch { parsed = null; }
            
            if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
              throw new Error('WEBHOOK_TEST_INACTIVE');
            }
            if (!parsed) throw new Error('INVALID_JSON');
            if (!hasMeaningfulRows(parsed)) throw new Error('NO_ROWS_FOUND');
            return { parsed, source: url };
          } catch (e) {
            lastErr = e;
            console.log('[Form2 Debug] Fetch failed:', e.message);
            continue;
          }
        }
        throw lastErr || new Error('FETCH_FAILED');
        }

        let data = null; let sourceUsed = '';
        try {
          const result = await fetchJsonWithProxyChain(baseUrl);
          data = result.parsed; sourceUsed = result.source;
        } catch (e) {
          throw e;
        }

        function pickRows(json) {
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data', 'rows', 'result', 'records', 'items', 'list'];
          for (const k of candidates) { if (Array.isArray(json?.[k])) return json[k]; }
          try {
            const queue = [json];
            const seen = new Set();
            while (queue.length) {
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)) {
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          } catch (_) { }
          return [];
        }

        let rows = pickRows(data);
        console.log('[Form2 Debug] Raw data received:', Array.isArray(data) ? `Array(${data.length})` : (data && typeof data === 'object' ? 'Object' : typeof data), 'from:', sourceUsed || 'unknown');
        console.log('[Form2 Debug] Extracted rows count:', rows.length);
        console.log('[Form2 Debug] First few rows:', rows.slice(0, 3));
        
        // Khai báo getV function trước khi sử dụng
        const getV = (obj, keys) => {
          const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
          for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
          return '';
        };
        
        // (Hoãn) Không lưu dữ liệu gốc trước khi filter để tránh sai lệch khi tái tính theo tháng
        
        // Debug: Kiểm tra completionDate trong dữ liệu
        console.log('[Form2 Debug] Sample completionDate values:');
        let completionDateCount = 0;
        rows.slice(0, 5).forEach((item, index) => {
          const completionDate = getV(item, [
            'Ngày hoàn thành thực tế', 'ngày hoàn thành thực tế',
            'completionDate', 'completiondate', 'completedDate', 'completeddate',
            'completion_date', 'completed_date', 'done_date',
            'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay_hoan_thanh_thuc_te'
          ]);
          console.log(`[Form2 Debug] Row ${index}:`, completionDate);
          if (completionDate) completionDateCount++;
        });
        
        // Đếm tổng số completionDate trong toàn bộ dữ liệu
        const totalCompletionDates = rows.filter(item => {
          const completionDate = getV(item, [
            'Ngày hoàn thành thực tế', 'ngày hoàn thành thực tế',
            'completionDate', 'completiondate', 'completedDate', 'completeddate',
            'completion_date', 'completed_date', 'done_date',
            'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay_hoan_thanh_thuc_te'
          ]);
          return completionDate && String(completionDate).trim() !== '';
        }).length;
        console.log('[Form2 Debug] Total rows with completionDate:', totalCompletionDates, 'out of', rows.length);
        
        if (!rows.length) {
          console.log('[Form2 Debug] No rows found, showing empty message');
          body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>";
          return;
        }

        // Lọc bỏ các dòng không có Tên tác vụ (bổ sung 'Task Name')
        rows = rows.filter(item => String(getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 'tên tác vụ']) || '').trim() !== '');
        if (!rows.length) {
          body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>";
          return;
        }

        // Lưu dữ liệu gốc SAU KHI filter để đồng bộ tái tính khi đổi tháng
        F2_ALL_DATA = [...rows];
        console.log('[Form2 Debug] F2_ALL_DATA (filtered) saved with', F2_ALL_DATA.length, 'rows');

        // Tính toán thống kê theo nhân viên
        calculateEmployeeStats(rows);
        
        // Render bảng thống kê
        renderForm2Stats();
        
      } catch (err) {
        const isCors = /Failed to fetch|CORS|No 'Access-Control-Allow-Origin'|NetworkError|TypeError|JSONP_FAILED|JSONP_TIMEOUT/.test(String(err && (err.message || err)));
        const msg = isCors
          ? 'Bị chặn bởi CORS. Đã thử JSONP và fetch trực tiếp nhưng vẫn không thể kết nối. Vui lòng mở file qua web server (vd: Live Server) hoặc kiểm tra kết nối mạng.'
          : (String(err && err.name) === 'AbortError')
            ? 'Quá thời gian chờ (120s). Vui lòng thử lại.'
            : `Lỗi tải dữ liệu: ${String(err.message || err)}`;
        
        body.innerHTML = `<tr><td colspan='11' class='px-3 py-3 text-center text-red-600'>${msg}</td></tr>`;
      }
    }

    // Parser ngày linh hoạt: hỗ trợ YYYY-MM-DD[ HH:mm[:ss]], DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY, YYYY/MM/DD
    function parseDateFlexible(input){
      const s = String(input || '').trim();
      if (!s) return new Date('');
      // ISO-like or YYYY-MM-DD
      let m = s.match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/);
      if (m) {
        const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
        const hh = parseInt(m[4]||'0',10), mm = parseInt(m[5]||'0',10), ss = parseInt(m[6]||'0',10);
        return new Date(y, mo, d, hh, mm, ss);
      }
      // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
      m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/);
      if (m) {
        const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
        const hh = parseInt(m[4]||'0',10), mm = parseInt(m[5]||'0',10), ss = parseInt(m[6]||'0',10);
        return new Date(y, mo, d, hh, mm, ss);
      }
      // Fallback native
      const dt = new Date(s);
      return dt;
    }

    // Tính toán thống kê theo nhân viên
    function calculateEmployeeStats(rows) {
      console.log('[Form2 Debug] calculateEmployeeStats called with F2_MONTH_FILTER:', F2_MONTH_FILTER);
      F2_EMPLOYEE_STATS = {};
      
      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      // Chuẩn hoá chuỗi: bỏ dấu tiếng Việt, loại bỏ khoảng trắng/thanh nối để so khớp mềm
      const normalize = (s) => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .replace(/\s|_/g, '');

      // Tìm field Ngày hoàn thành thực tế theo nhiều biến thể tên cột
      const getCompletionDateFromItem = (item) => {
        // 1) Thử các key phổ biến (ưu tiên)
        const valDirect = getV(item, [
          'Ngày hoàn thành thực tế', 'ngày hoàn thành thực tế',
          'Ngày hoàn thành', 'ngày hoàn thành',
          'completionDate', 'completiondate', 'completedDate', 'completeddate',
          'completion_date', 'completed_date', 'done_date',
          'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay hoan thanh',
          'ngay_hoan_thanh_thuc_te', 'ngay hoan thanh thuc te'
        ]);
        if (valDirect) return valDirect;

        // 2) So khớp mềm: key chứa từ khoá "hoanthanh|completed|completion|done" và đồng thời chứa "ngay|date"
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasComplete = /(hoanthanh|completed?|completion|done)/.test(nk);
            const hasDate = /(ngay|date)/.test(nk);
            if (hasComplete && hasDate) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Tìm field Ngày yêu cầu (request date) theo nhiều biến thể tên cột
      const getRequestDateFromItem = (item) => {
        const valDirect = getV(item, [
          '📆 Ngày yêu cầu ', 'Ngày yêu cầu', 'ngày yêu cầu',
          'requestDate', 'requestdate', 'submissiondate',
          'ngayyeucau', 'ngay_yeu_cau', 'ngay gui', 'ngaygui'
        ]);
        if (valDirect) return valDirect;
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasReq = /(yeucau|request|submit|submission)/.test(nk);
            const hasDate = /(ngay|date)/.test(nk);
            if (hasReq && hasDate) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Tìm field Hạn mong muốn (wish due) theo nhiều biến thể tên cột
      const getWishDueFromItem = (item) => {
        const valDirect = getV(item, [
          'Hạn mong muốn ', 'Hạn mong muốn', 'hạn mong muốn',
          'wishDue', 'wishdue', 'desireddue',
          'hanmongmuon', 'han_mong_muon'
        ]);
        if (valDirect) return valDirect;
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasWish = /(mongmuon|wish|desire)/.test(nk);
            const hasDue = /(han|due|deadline)/.test(nk);
            if (hasWish && hasDue) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Khởi tạo thống kê cho tất cả nhân viên trong danh sách Form 2
      FORM2_NAMES.forEach(name => {
        F2_EMPLOYEE_STATS[name] = {
          name: name,
          totalTasks: 0, // Tổng số tác vụ đang thực hiện (Doing)
          done: 0, // Số Done trong tháng được chọn
          ahead: 0,
          ontime: 0,
          late: 0,
          na: 0,
          tasks: []
        };
      });

      rows.forEach(item => {
        // Sử dụng danh sách fallback keys giống Form 5
        const assignee = getV(item, [
          'Assignee', 'Assignee Name', 'AssigneeName', 'Assignee name',
          'Phụ trách', 'Phụ trách chính', 'Người phụ trách', 'Người xử lý', 'Người nhận mẫu', 'Người nhận',
          'employee', 'nhanvien', 'nhan_vien', 'nhân viên', 'user', 'name', 'receiver', 'recipient', 'pic', 'nguoi_phu_trach', 'người phụ trách',
          'assignee', 'nguoi_nhan', 'người nhận', 'nguoi_thuc_hien', 'người thực hiện', 'name_1', 'Name 1'
        ]);
        
        if (!assignee || assignee.trim() === '') {
          return;
        }

        // Nếu tên không có trong danh sách, tạo mới để không bỏ sót dữ liệu
        if (!F2_EMPLOYEE_STATS[assignee]) {
          F2_EMPLOYEE_STATS[assignee] = {
            name: assignee,
            totalTasks: 0, // Tổng số tác vụ đang thực hiện (Doing)
            done: 0, // Số Done trong tháng được chọn
            ahead: 0,
            ontime: 0,
            late: 0,
            na: 0,
            tasks: []
          };
        }

        // Đếm tổng số tác vụ đang thực hiện (chỉ trạng thái Doing)
        const status = getV(item, ['⁉️ Kết quả', 'status', 'trangthai', 'trang_thai', 'trạng thái', 'ket_qua', 'result']);
        const statusLower = (status || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        
        if (isDoing) {
          F2_EMPLOYEE_STATS[assignee].totalTasks++;
        }

        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        
        // Tính toán tiến độ
        const requestDate = getRequestDateFromItem(item);
        const wishDue = getWishDueFromItem(item);
        const completionDate = getCompletionDateFromItem(item);
        
        // Đếm Done trong phạm vi tháng đang lọc (hoặc tất cả nếu không lọc) và chỉ phân loại cho những tác vụ được đếm
        let isCountedDone = false;
        if (completionDate) {
          const compDate = parseDateFlexible(completionDate);
          if (!isNaN(compDate.getTime())) {
            if (F2_MONTH_FILTER) {
              const compYear = compDate.getFullYear();
              const compMonth = String(compDate.getMonth() + 1).padStart(2, '0');
              const compMonthStr = `${compYear}-${compMonth}`;
              if (compMonthStr === F2_MONTH_FILTER) {
                F2_EMPLOYEE_STATS[assignee].done++;
                isCountedDone = true;
              }
            } else {
              F2_EMPLOYEE_STATS[assignee].done++;
              isCountedDone = true;
            }
          }
        }

        // Chỉ tính Vượt/Đúng/Chậm/N/A cho các tác vụ Done đã được tính vào mẫu số (isCountedDone)
        if (isCountedDone) {
          if (requestDate && wishDue && completionDate) {
            const reqDate = parseDateFlexible(requestDate);
            const wishDate = parseDateFlexible(wishDue);
            const compDate = parseDateFlexible(completionDate);
            if (!isNaN(reqDate.getTime()) && !isNaN(wishDate.getTime()) && !isNaN(compDate.getTime())) {
              const daysDiff = (compDate.getTime() - wishDate.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff < 0) {
                F2_EMPLOYEE_STATS[assignee].ahead++;
              } else if (daysDiff <= 1) {
                F2_EMPLOYEE_STATS[assignee].ontime++;
              } else {
                F2_EMPLOYEE_STATS[assignee].late++;
              }
            } else {
              F2_EMPLOYEE_STATS[assignee].na++;
            }
          } else {
            F2_EMPLOYEE_STATS[assignee].na++;
          }
        }

        // Lưu thông tin tác vụ đầy đủ cho modal với mapping JSON mới
        const reqDateStr = getRequestDateFromItem(item);
        const wishDueStr = getWishDueFromItem(item);
        const completionDateStr = getCompletionDateFromItem(item);
        F2_EMPLOYEE_STATS[assignee].tasks.push({
          // Core fields cho modal (8 cột) - Mapping chính xác theo yêu cầu
          code: getV(item, ['🆔 Mã Báo cáo', 'Mã tác vụ', 'code', 'ma', 'taskcode', 'mã', 'mã_báo_cáo']),
          taskName: getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 'tên tác vụ']),
          requester: getV(item, ['Người yêu cầu', '🖊️ Tên NCC ', 'requester', 'nguoiyeucau', 'nguoi_yeu_cau', 'assigner', 'người yêu cầu']),
          requestDate: reqDateStr,
          wishDue: wishDueStr,
          note: getV(item, ['Ghi chú', 'note', 'ghi_chu', 'ghichu', 'comments', 'bình_luận']),
          completionDate: completionDateStr,
          status: status,
          progress: calculateProgress(reqDateStr, wishDueStr, completionDateStr),
          
          // Additional fields từ JSON mới
          assigneeField: getV(item, ['Assignee', 'assignee', 'nguoi_nhan', 'người nhận', 'nguoi_thuc_hien', 'người thực hiện']),
          emailAssigner: getV(item, ['Email Assigner', 'email_assigner', 'email_nguoi_yeu_cau']),
          emailAssignee: getV(item, ['EmailofAssignee', 'email_assignee', 'email_nguoi_thuc_hien']),
          telegramMsgId: getV(item, ['TelegramMsgId', 'telegram_msg_id', 'telegram_message_id']),
          linkCongViec: getV(item, ['Link Công Việc', 'link_cong_viec', 'link_work']),
          logGuiCongViec: getV(item, ['Log gửi công việc', 'log_gui_cong_viec', 'log_send_work']),
          ketQua: getV(item, ['⁉️ Kết quả', 'ket_qua', 'result', 'status']),
          maBaoCao: getV(item, ['🆔 Mã Báo cáo', 'ma_bao_cao', 'report_code', 'report_id']),
          emailId: getV(item, ['Email ID', 'email_id']),
          name1: getV(item, ['Name 1', 'name_1', 'nguoi_thuc_hien']),
          email1: getV(item, ['Email 1', 'email_1']),
          linkBC: getV(item, ['LinkBC', 'link_bc', 'link_bao_cao']),
          nhanXetTruongNhom: getV(item, ['Nhận xét trưởng nhóm', 'nhan_xet_truong_nhom', 'team_lead_comment']),
          ngayBoSung: getV(item, ['Ngày bổ sung', 'ngay_bo_sung', 'supplement_date']),
          maPheDuyet: getV(item, ['Mã phê duyệt', 'ma_phe_duyet', 'approval_code']),
          nhanXetTruongPhong: getV(item, ['Nhận xét trưởng phòng', 'nhan_xet_truong_phong', 'department_head_comment']),
          
          // Test fields từ JSON
          ghiChu2a: getV(item, ['Ghi chú 2a', 'ghi_chu_2a']),
          diemNG3a: getV(item, ['3a Điểm NG ', 'diem_ng_3a', 'point_ng_3a']),
          ghiChu3a: getV(item, ['Ghi chú 3a', 'ghi_chu_3a']),
          testBen4a: getV(item, ['4a Test bền ', 'test_ben_4a', 'durability_test_4a']),
          ghiChu4a: getV(item, ['Ghi chú 4a', 'ghi_chu_4a']),
          baiTestKhac5a: getV(item, ['5a Bài test khác', 'bai_test_khac_5a', 'other_test_5a']),
          ghiChu5a: getV(item, ['Ghi chú 5a', 'ghi_chu_5a']),
          fileAttachment: getV(item, ['File attachment ', 'file_attachment', 'attachment_file']),
          
          // Additional comprehensive fields
          assignee: assignee,
          priority: getV(item, ['priority', 'độ_ưu_tiên', 'do_uu_tien', 'mức_độ_quan_trọng']),
          category: getV(item, ['category', 'loại', 'loai', 'phân_loại', 'phan_loai']),
          department: getV(item, ['department', 'phòng_ban', 'phong_ban', 'bộ_phận', 'bo_phan']),
          project: getV(item, ['project', 'dự_án', 'du_an', 'dự_án', 'du_an']),
          estimatedHours: getV(item, ['estimatedHours', 'estimated_hours', 'giờ_ước_tính', 'gio_uoc_tinh']),
          actualHours: getV(item, ['actualHours', 'actual_hours', 'giờ_thực_tế', 'gio_thuc_te']),
          createdDate: getV(item, ['createdDate', 'created_date', 'ngày_tạo', 'ngay_tao']),
          updatedDate: getV(item, ['updatedDate', 'updated_date', 'ngày_cập_nhật', 'ngay_cap_nhat']),
          createdBy: getV(item, ['createdBy', 'created_by', 'người_tạo', 'nguoi_tao']),
          updatedBy: getV(item, ['updatedBy', 'updated_by', 'người_cập_nhật', 'nguoi_cap_nhat']),
          tags: getV(item, ['tags', 'thẻ', 'the', 'nhãn', 'nhan']),
          comments: getV(item, ['comments', 'bình_luận', 'binh_luan', 'ghi_chú', 'ghi_chu']),
          attachments: getV(item, ['attachments', 'tệp_đính_kèm', 'tep_dinh_kem', 'file_attachments']),
          relatedTasks: getV(item, ['relatedTasks', 'related_tasks', 'tác_vụ_liên_quan', 'tac_vu_lien_quan']),
          dependencies: getV(item, ['dependencies', 'phụ_thuộc', 'phu_thuoc', 'ràng_buộc', 'rang_buoc']),
          riskLevel: getV(item, ['riskLevel', 'risk_level', 'mức_độ_rủi_ro', 'muc_do_rui_ro']),
          complexity: getV(item, ['complexity', 'độ_phức_tạp', 'do_phuc_tap', 'mức_độ_phức_tạp']),
          qualityScore: getV(item, ['qualityScore', 'quality_score', 'điểm_chất_lượng', 'diem_chat_luong']),
          feedback: getV(item, ['feedback', 'phản_hồi', 'phan_hoi', 'đánh_giá', 'danh_gia']),
          lessonsLearned: getV(item, ['lessonsLearned', 'lessons_learned', 'bài_học', 'bai_hoc', 'kinh_nghiệm']),
          nextSteps: getV(item, ['nextSteps', 'next_steps', 'bước_tiếp_theo', 'buoc_tiep_theo']),
          resources: getV(item, ['resources', 'tài_nguyên', 'tai_nguyen', 'nguồn_lực', 'nguon_luc']),
          tools: getV(item, ['tools', 'công_cụ', 'cong_cu', 'dụng_cụ', 'dung_cu']),
          methodology: getV(item, ['methodology', 'phương_pháp', 'phuong_phap', 'quy_trình', 'quy_trinh']),
          standards: getV(item, ['standards', 'tiêu_chuẩn', 'tieu_chuan', 'chuẩn_mực', 'chuan_muc']),
          compliance: getV(item, ['compliance', 'tuân_thủ', 'tuan_thu', 'tuân_thủ_quy_định']),
          approvalStatus: getV(item, ['approvalStatus', 'approval_status', 'trạng_thái_phê_duyệt', 'trang_thai_phe_duyet']),
          approver: getV(item, ['approver', 'người_phê_duyệt', 'nguoi_phe_duyet', 'người_duyệt']),
          approvalDate: getV(item, ['approvalDate', 'approval_date', 'ngày_phê_duyệt', 'ngay_phe_duyet']),
          reviewStatus: getV(item, ['reviewStatus', 'review_status', 'trạng_thái_đánh_giá', 'trang_thai_danh_gia']),
          reviewer: getV(item, ['reviewer', 'người_đánh_giá', 'nguoi_danh_gia', 'người_review']),
          reviewDate: getV(item, ['reviewDate', 'review_date', 'ngày_đánh_giá', 'ngay_danh_gia']),
          testStatus: getV(item, ['testStatus', 'test_status', 'trạng_thái_test', 'trang_thai_test']),
          tester: getV(item, ['tester', 'người_test', 'nguoi_test', 'người_kiểm_thử']),
          testDate: getV(item, ['testDate', 'test_date', 'ngày_test', 'ngay_test']),
          deploymentStatus: getV(item, ['deploymentStatus', 'deployment_status', 'trạng_thái_triển_khai', 'trang_thai_trien_khai']),
          deploymentDate: getV(item, ['deploymentDate', 'deployment_date', 'ngày_triển_khai', 'ngay_trien_khai']),
          performance: getV(item, ['performance', 'hiệu_suất', 'hieu_suat', 'hiệu_quả', 'hieu_qua']),
          metrics: getV(item, ['metrics', 'chỉ_số', 'chi_so', 'metric', 'thước_đo']),
          kpis: getV(item, ['kpis', 'kpi', 'chỉ_số_kpi', 'chi_so_kpi']),
          sla: getV(item, ['sla', 'thỏa_thuận_dịch_vụ', 'thoa_thuan_dich_vu']),
          budget: getV(item, ['budget', 'ngân_sách', 'ngan_sach', 'kinh_phí', 'kinh_phi']),
          cost: getV(item, ['cost', 'chi_phí', 'chi_phi', 'giá_trị', 'gia_tri']),
          roi: getV(item, ['roi', 'lợi_nhuận_đầu_tư', 'loi_nhuan_dau_tu', 'hiệu_quả_đầu_tư']),
          impact: getV(item, ['impact', 'tác_động', 'tac_dong', 'ảnh_hưởng', 'anh_huong']),
          benefits: getV(item, ['benefits', 'lợi_ích', 'loi_ich', 'lợi_thế', 'loi_the']),
          challenges: getV(item, ['challenges', 'thách_thức', 'thach_thuc', 'khó_khăn', 'kho_khan']),
          solutions: getV(item, ['solutions', 'giải_pháp', 'giai_phap', 'cách_giải_quyết']),
          recommendations: getV(item, ['recommendations', 'khuyến_nghị', 'khuyen_nghi', 'đề_xuất', 'de_xuat']),
          
          // Lưu raw data để có thể truy cập đầy đủ
          rawData: item
        });
      });

      // Tính phần trăm cho tất cả nhân viên trong danh sách Form 2
      FORM2_NAMES.forEach(name => {
        const stat = F2_EMPLOYEE_STATS[name];
        if (stat) {
          const total = stat.done;
          if (total > 0) {
            stat.aheadPct = ((stat.ahead / total) * 100).toFixed(1);
            stat.ontimePct = ((stat.ontime / total) * 100).toFixed(1);
            stat.latePct = ((stat.late / total) * 100).toFixed(1);
            stat.naPct = ((stat.na / total) * 100).toFixed(1);
          } else {
            stat.aheadPct = "0";
            stat.ontimePct = "0";
            stat.latePct = "0";
            stat.naPct = "0";
          }
        }
      });
      
      console.log('[Form2 Debug] Final F2_EMPLOYEE_STATS:', F2_EMPLOYEE_STATS);
    }

    // Tính toán tiến độ
    function calculateProgress(requestDate, wishDue, completionDate) {
      if (!requestDate || !wishDue || !completionDate) return 'N/A';
      
      // Hỗ trợ cả 2 định dạng: YYYY-MM-DD HH:mm và YYYY-MM-DD
      let reqDate, wishDate, compDate;
      
      // Parse requestDate
      if (requestDate.includes(' ')) {
        reqDate = new Date(requestDate);
      } else {
        reqDate = new Date(requestDate + ' 00:00:00');
      }
      
      // Parse wishDue
      if (wishDue.includes(' ')) {
        wishDate = new Date(wishDue);
      } else {
        wishDate = new Date(wishDue + ' 00:00:00');
      }
      
      // Parse completionDate
      if (completionDate.includes(' ')) {
        compDate = new Date(completionDate);
      } else {
        compDate = new Date(completionDate + ' 00:00:00');
      }
      
      if (isNaN(reqDate.getTime()) || isNaN(wishDate.getTime()) || isNaN(compDate.getTime())) {
        return 'N/A';
      }
      
      const daysDiff = (compDate.getTime() - wishDate.getTime()) / (1000 * 60 * 60 * 24);
      
      if (daysDiff < 0) return 'Vượt tiến độ';
      if (daysDiff <= 1) return 'Đúng tiến độ';
      return 'Chậm tiến độ';
    }

    // Render bảng thống kê
    function renderForm2Stats() {
      const body = document.getElementById('f2-body-p1');
      if (!body) return;

      // Hiển thị tất cả nhân viên có trong thống kê (bao gồm tên mới xuất hiện trong dữ liệu)
      const allNames = Object.keys(F2_EMPLOYEE_STATS);
      if (allNames.length === 0) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Chưa có dữ liệu</td></tr>';
        return;
      }

      // Ưu tiên sắp xếp: tên trong FORM2_NAMES trước, sau đó các tên mới theo alpha
      const preferredSet = new Set(FORM2_NAMES);
      allNames.sort((a,b)=>{
        const aPref = preferredSet.has(a) ? 0 : 1;
        const bPref = preferredSet.has(b) ? 0 : 1;
        if (aPref !== bPref) return aPref - bPref;
        return a.localeCompare(b, 'vi');
      });

      body.innerHTML = '';
      allNames.forEach(name => {
        const stat = F2_EMPLOYEE_STATS[name] || {
          name: name,
          totalTasks: 0,
          done: 0,
          ahead: 0,
          ontime: 0,
          late: 0,
          na: 0,
          aheadPct: "0",
          ontimePct: "0",
          latePct: "0",
          naPct: "0",
          tasks: []
        };
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 font-medium cursor-pointer hover:text-primary-blue" onclick="openF2P1DetailModal('${stat.name}')">${stat.name}</td>
          <td class="px-3 py-2 text-center font-semibold text-blue-600">${stat.totalTasks}</td>
          <td class="px-3 py-2 text-center">${stat.done}</td>
          <td class="px-3 py-2 text-center text-green-600">${stat.ahead}</td>
          <td class="px-3 py-2 text-center text-blue-600">${stat.ontime}</td>
          <td class="px-3 py-2 text-center text-red-600">${stat.late}</td>
          <td class="px-3 py-2 text-center text-gray-600">${stat.na}</td>
          <td class="px-3 py-2 text-center text-green-600">${stat.aheadPct || 0}%</td>
          <td class="px-3 py-2 text-center text-blue-600">${stat.ontimePct || 0}%</td>
          <td class="px-3 py-2 text-center text-red-600">${stat.latePct || 0}%</td>
          <td class="px-3 py-2 text-center text-gray-600">${stat.naPct || 0}%</td>
        `;
        body.appendChild(tr);
      });
    }

    // Form 2: Render panel data (legacy function - now calls fetchForm2Data)
    function renderForm2Panel(panelId) {
      if (panelId === 'p1') {
        fetchForm2Data();
      }
    }

    // Form 2: Search button event listeners
    document.querySelectorAll('[id^="f2-search-"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const panelId = btn.id.replace('f2-search-', '');
        
        // Show loading state
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        
        // Simulate API call
        setTimeout(() => {
          renderForm2Panel(panelId);
          btn.disabled = false;
          btn.textContent = originalText;
          showToast(`Đã tải dữ liệu ${panelId.toUpperCase()}.`, 'success');
        }, 1000);
      });
    });

    // Form 2: Export functionality
    const f2ExportBtn = document.getElementById('f2-export');
    const f2ExportXlsxBtn = document.getElementById('f2-export-xlsx');
    
    if (f2ExportBtn) {
      f2ExportBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showToast('Chức năng xuất server đang được phát triển.', 'info');
      });
    }
    
    if (f2ExportXlsxBtn) {
      f2ExportXlsxBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showToast('Chức năng xuất XLSX đang được phát triển.', 'info');
      });
    }

    // Form 2: Modal functions
    function openF2P1DetailModal(employeeName) {
      const modal = document.getElementById('f2-p1-detail-modal');
      const nameSpan = document.getElementById('f2-p1-detail-name');
      const body = document.getElementById('f2-p1-detail-body');
      
      if (nameSpan) nameSpan.textContent = employeeName;
      
      // Lấy dữ liệu thực từ F2_EMPLOYEE_STATS
      const employeeData = F2_EMPLOYEE_STATS[employeeName];
      
      if (!employeeData || !employeeData.tasks || employeeData.tasks.length === 0) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Không có dữ liệu tác vụ</td></tr>';
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        return;
      }
      
      // Lọc: chỉ hiển thị các tác vụ được đếm
      // - Luôn gồm các tác vụ Doing (được tính vào totalTasks)
      // - Và các tác vụ Done có completionDate nằm trong F2_MONTH_FILTER (nếu đang lọc tháng)
      // - Nếu không lọc tháng, hiển thị Doing và tất cả Done có completionDate
      const filtered = (employeeData.tasks || []).filter(task => {
        const statusLower = String(task.status || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        if (isCancelled) return false;
        if (isDoing) return true;
        if (!isDone) return false;
        const comp = task.completionDate;
        if (!comp) return false;
        const compDate = parseDateFlexible(comp);
        if (isNaN(compDate.getTime())) return false;
        if (F2_MONTH_FILTER) {
          const ym = `${compDate.getFullYear()}-${String(compDate.getMonth()+1).padStart(2,'0')}`;
          return ym === F2_MONTH_FILTER;
        }
        return true;
      });

      // Sắp xếp: Doing trên, Done phía dưới (giữ nguyên thứ tự bên trong mỗi nhóm)
      const sorted = filtered.sort((a,b)=>{
        const aStatus = String(a.status||'').toLowerCase();
        const bStatus = String(b.status||'').toLowerCase();
        const aDoing = aStatus.includes('doing') || aStatus.includes('đang');
        const bDoing = bStatus.includes('doing') || bStatus.includes('đang');
        if (aDoing && !bDoing) return -1;
        if (!aDoing && bDoing) return 1;
        return 0;
      });

      body.innerHTML = '';
      sorted.forEach((task) => {
        const tr = document.createElement('tr');
        
        // Tạo badge trạng thái
        const statusLower = (task.status || '').toLowerCase();
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        const statusBadge = `<span class="px-2 py-1 rounded text-xs ${isDone ? 'bg-green-100 text-green-800' : (isCancelled || statusLower.includes('chờ') || statusLower.includes('pending')) ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${task.status || ''}</span>`;
        
        tr.innerHTML = `
          <td class="px-3 py-2">${statusBadge}</td>
          <td class="px-3 py-2">${task.completionDate || '-'}</td>
          <td class="px-3 py-2">${task.code || '-'}</td>
          <td class="px-3 py-2">${task.taskName || '-'}</td>
          <td class="px-3 py-2">${task.requester || '-'}</td>
          <td class="px-3 py-2">${task.requestDate || '-'}</td>
          <td class="px-3 py-2">${task.wishDue || '-'}</td>
          <td class="px-3 py-2">${task.note || '-'}</td>
        `;
        body.appendChild(tr);
      });
      
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeF2P1DetailModal() {
      const modal = document.getElementById('f2-p1-detail-modal');
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }

    // Form 2: Modal event listeners
    const f2P1DetailCloseBtn = document.getElementById('f2-p1-detail-close');
    if (f2P1DetailCloseBtn) {
      f2P1DetailCloseBtn.addEventListener('click', closeF2P1DetailModal);
    }

    const f2P1DetailModal = document.getElementById('f2-p1-detail-modal');
    if (f2P1DetailModal) {
      f2P1DetailModal.addEventListener('click', (e) => {
        if (e.target === f2P1DetailModal) closeF2P1DetailModal();
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && f2P1DetailModal.classList.contains('open')) {
        closeF2P1DetailModal();
      }
    });

    // Initialize Form 2 with P1
    setTimeout(() => {
      fetchForm2Data();
    }, 100);


  </script>
</body>
</html>








