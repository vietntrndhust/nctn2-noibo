<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>C·ªïng T√°c V·ª• NCTN 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#C41E3A',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #C41E3A;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#C41E3A 0%,#EF4444 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(196,30,58,.15);color:#7f1d1d;border:1px solid rgba(196,30,58,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#C41E3A 0%,#EF4444 100%);box-shadow:0 4px 6px rgba(196,30,58,.1),0 1px 3px rgba(196,30,58,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(196,30,58,.12),0 3px 6px rgba(196,30,58,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Form 2: Tab styling */
    .f2-panel{transition:all .2s ease}
    .f2-panel.hidden{display:none}
    /* Form 2: Table styling */
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .cell-div{ border-left:1px solid #e5e7eb; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside class="w-64 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-red-200 mb-4">C·ªïng T√°c V·ª• NCTN 2</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form1">Form 1 ¬∑ Tra c·ª©u t√°c v·ª•</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form2">Form 2 ¬∑ T·∫•t c·∫£ t√°c v·ª•</button>
      <!-- <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form4">Form 4 ¬∑ B·∫£ng theo d√µi </button> -->
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-10 flex flex-col items-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Ph√≤ng NCTN 2</div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">C·ªïng t√°c v·ª• NCTN 2 - N·ªôi b·ªô</h2>
        <p class="text-red-100 text-sm md:text-base">Vui l√≤ng kh√¥ng chia s·∫ª link c·ªïng t√°c v·ª• v·ªõi ng∆∞·ªùi ngo√†i b·ªô ph·∫≠n.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-red-800">Form 1 ¬∑ Tra c·ª©u t√°c v·ª•</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
            <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
            <button id="f1-unassigned" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Ch∆∞a ph√¢n c√¥ng</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ g·ª≠i y√™u c·∫ßu v√† hi·ªÉn th·ªã t√°c v·ª•</p>
        </div>
        <div class="md:col-span-2">
          <div class="flex items-center gap-3">
            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">L·ªçc theo th√°ng:</label>
            <select id="f1-month" class="w-40 border border-red-300 rounded-lg bg-slate-100 p-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
              <option value="">‚Äî T·∫•t c·∫£ th√°ng ‚Äî</option>
            </select>
            <button id="f1-clear-filter" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">X√≥a l·ªçc</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">C√°c t√°c v·ª• Doing s·∫Ω lu√¥n hi·ªán l√™n ƒë·∫ßu v√† kh√¥ng b·ªã l·ªçc theo th√°ng</p>
        </div>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1760px] w-full text-sm">
          <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px]">Tr·∫£ b√°o c√°o</th>
              <th class="px-3 py-2 min-w-[140px]">T√¨nh tr·∫°ng</th>
              <th class="px-3 py-2 min-w-[160px]">Ng√†y ho√†n th√†nh th·ª±c t·∫ø</th>
              <th class="px-3 py-2 min-w-[140px]">M√£</th>
              <th class="px-3 py-2 min-w-[260px]">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[120px]">C√¥ng chu·∫©n</th>
              <th class="px-3 py-2 min-w-[140px]">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-3 py-2 min-w-[260px]">M·ª•c ƒë√≠ch ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[240px]">Note</th>
              <th class="px-3 py-2 min-w-[240px]">Y√™u c·∫ßu test ƒë·∫∑c bi·ªát</th>
              <th class="px-3 py-2 min-w-[260px]">Form b√°o c√°o ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[220px]">T√™n file ƒë√≠nh k√®m</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="f1-size" class="border border-red-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Tr∆∞·ªõc</button>
          <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>

      <!-- ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m -->
      <div class="mt-4">
        <a id="f1-storage-link" href="https://drive.google.com/drive/u/0/folders/1iVSNn6Ddv6jEun6lyMvOMcan2fpnFSpU" target="_blank" rel="noopener" title="Nh·∫•n ƒë·ªÉ m·ªü v√† t·ª± ƒë·ªông copy li√™n k·∫øt"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-red-200 bg-red-50/30 text-primary-blue hover:bg-red-50">
          ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m
        </a>
        <p class="text-xs text-gray-500 mt-1">Nh·∫•n ƒë·ªÉ m·ªü v√† copy li√™n k·∫øt.</p>
      </div>
    </section>

    <!-- Form 2 ¬∑ T·∫•t c·∫£ t√°c v·ª• -->
    <section id="form2" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-red-800">Form 2 ¬∑ T·∫•t c·∫£ t√°c v·ª•</h2>
        <div class="flex items-center gap-2">
          <button id="f2-export" class="px-3 py-1 rounded-lg border border-red-300 text-primary-blue bg-red-50 hover:bg-red-100">Xu·∫•t server</button>
          <button id="f2-export-xlsx" class="px-3 py-1 rounded-lg border border-red-300 text-primary-blue bg-red-50 hover:bg-red-100">Xu·∫•t XLSX</button>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Th√°ng</label>
          <input id="f2-month" type="month" class="border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white"/>
        </div>
        <!-- P1 Header -->
        <div class="mt-2 flex items-center gap-2 border-b border-gray-200">
          <div class="px-4 py-2 font-semibold text-red-800 bg-red-50 rounded-t-lg border-b-2 border-red-200">Th·ªëng k√™ ti·∫øn ƒë·ªô</div>
        </div>
        <!-- Th·∫ª P1: Th·ªëng k√™ ti·∫øn ƒë·ªô -->
        <div id="f2-panel-p1" class="f2-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-red-50 to-white flex items-center justify-center">
            <span class="font-semibold text-red-800 mr-4">Th·∫ª - Th·ªëng k√™ ti·∫øn ƒë·ªô</span>
            <button id="f2-search-p1" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra c·ª©u</button>
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
          <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nh√¢n vi√™n</th>
              <th class="px-3 py-2">T·ªïng t√°c v·ª• ƒëang th·ª±c hi·ªán</th>
              <th class="px-3 py-2">S·ªë Done trong th√°ng</th>
              <th class="px-3 py-2">V∆∞·ª£t ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">ƒê√∫ng ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">Ch·∫≠m ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">S·ªë N/A</th>
              <th class="px-3 py-2">T·ª∑ l·ªá v∆∞·ª£t (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ƒë√∫ng (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ch·∫≠m (%)</th>
              <th class="px-3 py-2">%N/A</th>
            </tr>
          </thead>
            <tbody id="f2-body-p1" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-red-50 to-white border-b border-gray-200">
        <h3 id="upload-title" class="text-base font-semibold text-gray-800">G·ª≠i b√°o c√°o</h3>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200">Ng∆∞·ªùi n·ªôp: <b class="ml-1" id="uploader-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200">M√£: <b class="ml-1" id="uploader-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200">T√°c v·ª•: <b class="ml-1" id="uploader-task"></b></span>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t·ªáp b√°o c√°o</label>
          <input id="upload-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <p class="text-xs text-gray-500 mt-1">T·ªáp s·∫Ω g·ª≠i k√®m timestamp t·∫°i th·ªùi ƒëi·ªÉm g·ª≠i.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫ (t√πy ch·ªçn)</label>
          <textarea id="upload-note" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ b√°o c√°o..." class="w-full border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white"></textarea>
          <p class="text-xs text-gray-500 mt-1">Ghi ch√∫ s·∫Ω ƒë∆∞·ª£c g·ª≠i k√®m v·ªõi b√°o c√°o.</p>
        </div>
        <div id="bps-option" class="flex items-center gap-2" style="display:none">
          <input id="upload-bps" type="checkbox" class="h-4 w-4">
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Tr·∫£ b√°o c√°o BPS</label>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
        <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i b√°o c√°o</button>
      </div>
    </div>
  </div>

  <!-- Modal: Chi ti·∫øt t√°c v·ª• theo nh√¢n vi√™n (Form 2 P1) -->
  <div id="f2-p1-detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f2-p1-detail-title">
    <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
      <div class="px-4 py-3 bg-gradient-to-b from-red-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="f2-p1-detail-title" class="text-base font-semibold text-gray-800">Chi ti·∫øt t√°c v·ª• c·ªßa <span id="f2-p1-detail-name" class="text-primary-blue"></span></h3>
        <button id="f2-p1-detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[1200px] w-full text-sm">
            <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2 min-w-[140px]">T√¨nh tr·∫°ng</th>
                <th class="px-3 py-2 min-w-[160px]">Ng√†y ho√†n th√†nh th·ª±c t·∫ø</th>
                <th class="px-3 py-2 min-w-[140px]">M√£</th>
                <th class="px-3 py-2 min-w-[260px]">T√™n t√°c v·ª•</th>
                <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi y√™u c·∫ßu</th>
                <th class="px-3 py-2 min-w-[140px]">Ng√†y y√™u c·∫ßu</th>
                <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
                <th class="px-3 py-2 min-w-[240px]">Note</th>
              </tr>
            </thead>
            <tbody id="f2-p1-detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="w-full max-w-5xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-red-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="detail-title" class="text-base font-semibold text-gray-800">Nhi·ªám v·ª• c·ªßa <span id="detail-name" class="text-primary-blue"></span></h3>
        <button id="detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
      </div>
      <div class="p-4">
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">M√£</th>
                <th class="px-3 py-2">T√™n t√°c v·ª•</th>
                <th class="px-3 py-2">Tr·∫°ng th√°i</th>
                <th class="px-3 py-2">C√¥ng chu·∫©n</th>
                <th class="px-3 py-2">Ng√†y y√™u c·∫ßu</th>
                <th class="px-3 py-2">H·∫°n mong mu·ªën</th>
                <th class="px-3 py-2">H·∫°n ƒë√°p ·ª©ng</th>
                <th class="px-3 py-2">Ng√†y ho√†n th√†nh</th>
              </tr>
            </thead>
            <tbody id="detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
      </div>
    </div>
  </div>


  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://xcqiyibqs.tino.page/webhook/tracuutacvuNCTN2";
    const FORM2_WEBHOOK_URL = "https://xcqiyibqs.tino.page/webhook/Tracuutongtacvu";
    const FORM1_UPLOAD_URL = "https://xcqiyibqs.tino.page/webhook/TrabaocaoNTCN2";
    let F4_CHART = null;

    // H√†m format timestamp theo ƒë·ªãnh d·∫°ng DD HH:mm GMT+7
    function formatTimestampGMT7() {
      const now = new Date();
      // Chuy·ªÉn ƒë·ªïi sang GMT+7 (UTC+7)
      const gmt7 = new Date(now.getTime() + (7 * 60 * 60 * 1000));
      
      const year = gmt7.getUTCFullYear();
      const month = String(gmt7.getUTCMonth() + 1).padStart(2, '0');
      const day = String(gmt7.getUTCDate()).padStart(2, '0');
      const hours = String(gmt7.getUTCHours()).padStart(2, '0');
      const minutes = String(gmt7.getUTCMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1', 'form2'].map(id=>document.getElementById(id));
    function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        const target = btn.getAttribute('data-target');
        showSection(target);
        
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Names - Form 1
    const FORM1_NAMES = [
      "Tr·∫ßn VƒÉn Ho√†ng",
      "Nguy·ªÖn Kim C∆∞∆°ng",
      "Tr·ªãnh Xu√¢n H·∫°nh",
      "ƒê·ªó Xu√¢n Huy",
      "Giang VƒÉn To√†n",
      "V≈© Ng·ªçc Di·ªáp",
      "B√πi Ng·ªçc H√πng",
      "Nh√¢n Vi√™n M·ªõi 1",
      "Nh√¢n Vi√™n M·ªõi 2",
    ];

    // Names - Form 2 (NCTN 2) - Danh s√°ch ri√™ng bi·ªát
    const FORM2_NAMES = [
      "Tr·∫ßn VƒÉn Ho√†ng",
      "Nguy·ªÖn Kim C∆∞∆°ng", 
      "Tr·ªãnh Xu√¢n H·∫°nh",
      "ƒê·ªó Xu√¢n Huy",
      "Giang VƒÉn To√†n",
      "V≈© Ng·ªçc Di·ªáp",
      "B√πi Ng·ªçc H√πng",
      "Nh√¢n Vi√™n M·ªõi 1",
      "Nh√¢n Vi√™n M·ªõi 2",
    ];
    

    // D·ªØ li·ªáu t√°c v·ª• (kh·ªüi t·∫°o r·ªóng; s·∫Ω n·ªëi ngu·ªìn th·∫≠t sau)
    const demoTasksForm1 = {};
    

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);

    // Fill month dropdown
    function fillMonthSelect(){
      const monthSelect = document.getElementById('f1-month');
      if (!monthSelect) return;
      
      const months = [];
      const now = new Date();
      
      // T·∫°o danh s√°ch 12 th√°ng g·∫ßn nh·∫•t (bao g·ªìm th√°ng hi·ªán t·∫°i)
      for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthName = date.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' });
        const value = `${year}-${month}`;
        months.push({ value, text: monthName });
      }
      
      months.forEach(m => {
        const option = document.createElement('option');
        option.value = m.value;
        option.textContent = m.text;
        monthSelect.appendChild(option);
      });
    }
    fillMonthSelect();

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Upload modal
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Ng∆∞·ªùi n·ªôp pill no longer needed (Form 2 removed)
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = 'none';
        if (bpsCheckbox) bpsCheckbox.checked = false;
      } catch(_) {}
      fileInput.value = '';
      const noteInput = document.getElementById('upload-note');
      if (noteInput) noteInput.value = '';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'G·ª≠i b√°o c√°o';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn t·ªáp b√°o c√°o.','error'); return; }
      const btn = document.getElementById('btn-send');
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', formatTimestampGMT7());
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        fd.append('ma_tac_vu', uploadContext.code||'');
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      const noteInput = document.getElementById('upload-note');
      const noteValue = noteInput ? (noteInput.value || '').trim() : '';
      fd.append('note', noteValue);
      fd.append('ghi_chu', noteValue);
      const bpsCheckbox = document.getElementById('upload-bps');
      fd.append('is_bps', '0');
      const targetUpload = FORM1_UPLOAD_URL;
      try{
        await fetch(targetUpload,{method:'POST',body:fd});
        showToast('ƒê√£ g·ª≠i b√°o c√°o.','success');
        closeUploadModal();
      }
      catch(e){
        console.error(e);
        showToast('G·ª≠i th·∫•t b·∫°i.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
      }
    };

    // Helpers for tables
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-2 align-top'; td.textContent=text; tr.appendChild(td); }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 10;
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} d√≤ng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    let F1_UNASSIGNED_MODE = false;
    let F1_MONTH_FILTER = '';
    let F1_ALL_DATA = []; // L∆∞u t·∫•t c·∫£ d·ªØ li·ªáu g·ªëc ƒë·ªÉ l·ªçc c·ª•c b·ªô

    // H√†m l·ªçc c·ª•c b·ªô theo th√°ng
    function applyLocalMonthFilter() {
      if (!F1_ALL_DATA.length) return;
      
      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      let filteredData = [...F1_ALL_DATA];

      // L·ªçc theo th√°ng n·∫øu c√≥ b·ªô l·ªçc
      if (F1_MONTH_FILTER) {
        filteredData = filteredData.filter(item => {
          const statusText = String(getV(item, ['status', 'trangthai', 'trang_thai', 'tr·∫°ng th√°i']) || '').toLowerCase();
          const isDoing = statusText.includes('doing') || statusText.includes('ƒëang');
          
          // T√°c v·ª• Doing lu√¥n hi·ªÉn th·ªã (kh√¥ng b·ªã l·ªçc theo th√°ng)
          // Nh∆∞ng v·∫´n ph·∫£i tu√¢n theo l·ªçc t√™n (ƒë√£ ƒë∆∞·ª£c l·ªçc t·ª´ server)
          if (isDoing) return true;
          
          // C√°c t√°c v·ª• kh√°c l·ªçc theo th√°ng
          const requestDate = getV(item, ['requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ng√†y y√™u c·∫ßu']);
          if (!requestDate) return false;
          
          const date = new Date(requestDate);
          if (isNaN(date.getTime())) return false;
          
          const itemYear = date.getFullYear();
          const itemMonth = String(date.getMonth() + 1).padStart(2, '0');
          const itemMonthStr = `${itemYear}-${itemMonth}`;
          
          return itemMonthStr === F1_MONTH_FILTER;
        });
      }

      // S·∫Øp x·∫øp: Doing tr∆∞·ªõc, sau ƒë√≥ theo th·ªùi gian t·ª´ g·∫ßn ƒë·∫øn xa
      filteredData.sort((a, b) => {
        const statusA = String(getV(a, ['status', 'trangthai', 'trang_thai', 'tr·∫°ng th√°i']) || '').toLowerCase();
        const statusB = String(getV(b, ['status', 'trangthai', 'trang_thai', 'tr·∫°ng th√°i']) || '').toLowerCase();
        
        const isDoingA = statusA.includes('doing') || statusA.includes('ƒëang');
        const isDoingB = statusB.includes('doing') || statusB.includes('ƒëang');
        
        // ∆Øu ti√™n Doing tr∆∞·ªõc
        if (isDoingA && !isDoingB) return -1;
        if (!isDoingA && isDoingB) return 1;
        
        // N·∫øu c√πng tr·∫°ng th√°i, s·∫Øp x·∫øp theo th·ªùi gian t·ª´ g·∫ßn ƒë·∫øn xa
        const getRequestDate = (item) => {
          const requestDate = getV(item, ['requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ng√†y y√™u c·∫ßu']);
          if (!requestDate) return new Date(0); // N·∫øu kh√¥ng c√≥ ng√†y, ƒë·∫∑t ·ªü cu·ªëi
          
          const date = new Date(requestDate);
          return isNaN(date.getTime()) ? new Date(0) : date;
        };
        
        const dateA = getRequestDate(a);
        const dateB = getRequestDate(b);
        
        // S·∫Øp x·∫øp t·ª´ g·∫ßn ƒë·∫øn xa (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
        return dateB.getTime() - dateA.getTime();
      });

      // Render l·∫°i b·∫£ng v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
      renderFilteredData(filteredData);
    }

    // H√†m render d·ªØ li·ªáu ƒë√£ l·ªçc
    function renderFilteredData(data) {
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      
      if (!data.length) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
        pager.style.display = 'none';
        return;
      }

      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      const nameSelected = (document.getElementById('f1-name').value || '').trim();

      F1_ALL_ROWS = [];
      data.forEach(item => {
        const tr = document.createElement('tr');
        const tdBtn = document.createElement('td'); 
        tdBtn.className = 'px-3 py-2';
        
        const code = getV(item, ['M√£ t√°c v·ª•', 'code', 'ma', 'taskcode', 'm√£']);
        const tname = getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 't√™n t√°c v·ª•']);
        
        // T·∫°o n√∫t Tr·∫£ b√°o c√°o - ch·ªâ cho ph√©p khi tr·∫°ng th√°i Doing
        const statusText = getV(item, ['‚ÅâÔ∏è K·∫øt qu·∫£', 'Hi·ªán tr·∫°ng', 'status', 'trangthai', 'trang_thai', 'tr·∫°ng th√°i']);
        const statusLower = (statusText || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('ƒëang');
        const isDone = statusLower.includes('ho√†n') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('h·ªßy') || statusLower.includes('hu·ª∑');
        const isEmptyStatus = statusLower.trim() === '';
        const isLocked = !isDoing; // Ch·ªâ cho ph√©p khi Doing

        const labelBtn = document.createElement('label');
        if (isLocked) {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60 pointer-events-none';
          if (isCancelled) {
            labelBtn.textContent = 'ƒê√£ h·ªßy';
          } else if (isDone) {
            labelBtn.textContent = 'ƒê√£ ho√†n th√†nh';
          } else if (isEmptyStatus) {
            labelBtn.textContent = 'Tr·∫°ng th√°i tr·ªëng';
          } else {
            labelBtn.textContent = 'Ch·ªâ Doing m·ªõi ƒë∆∞·ª£c g·ª≠i';
          }
        } else {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
          labelBtn.textContent = 'Tr·∫£ b√°o c√°o';
          labelBtn.onclick = (e) => {
            e.preventDefault();
            if (labelBtn.disabled) return;
            labelBtn.disabled = true;
            labelBtn.classList.add('opacity-50', 'pointer-events-none');
            lastOpenTrigger = labelBtn;
            openUploadModal({ form: 'Form 1', name: nameSelected, code, taskName: tname });
          };
        }
        
        tdBtn.appendChild(labelBtn);
        tr.appendChild(tdBtn);

        // C√°c c·ªôt kh√°c
        const tdStatus = document.createElement('td'); 
        tdStatus.className = 'px-3 py-2';
        const s = (statusText || '').toLowerCase();
        const badge = document.createElement('span'); 
        badge.className = 'px-2 py-1 rounded text-xs ' + (s.includes('ho√†n') || s.includes('done')
          ? 'bg-green-100 text-green-800'
          : (s.includes('cancel') || s.includes('h·ªßy') || s.includes('hu·ª∑') || s.includes('ch·ªù') || s.includes('pending'))
            ? 'bg-yellow-100 text-yellow-800'
            : 'bg-blue-100 text-blue-800');
        badge.textContent = statusText || ''; 
        tdStatus.appendChild(badge); 
        tr.appendChild(tdStatus);

        // Th√™m c·ªôt Ng√†y ho√†n th√†nh th·ª±c t·∫ø
        addTd(tr, getV(item, ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø', 'completiondate', 'completeddate', 'ngayhoanthanh', 'ngay_hoan_thanh', 'completion', 'done_date', 'ng√†y ho√†n th√†nh']));

        addTd(tr, code);
        addTd(tr, tname);
        addTd(tr, getV(item, ['üñäÔ∏è T√™n NCC ', 'requester', 'nguoiyeucau', 'nguoi_yeu_cau', 'assigner', 'ng∆∞·ªùi y√™u c·∫ßu']));
        addTd(tr, getV(item, ['C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n tu·∫ßn 22', 'manhour', 'man_hour', 'congchuan', 'cong_chuan', 'workload', 'sogio', 'sogiocong', 'c√¥ng chu·∫©n']));
        addTd(tr, getV(item, ['üìÜ Ng√†y y√™u c·∫ßu ', 'requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ng√†y y√™u c·∫ßu']));
        addTd(tr, getV(item, ['H·∫°n mong mu·ªën ', 'wishdue', 'hanmongmuon', 'han_mong_muon', 'desireddue', 'h·∫°n mong mu·ªën']));
        addTd(tr, getV(item, ['actualdue', 'handapung', 'han_dap_ung', 'completiondate', 'h·∫°n ƒë√°p ·ª©ng']));
        addTd(tr, getV(item, ['‚ùì M·ª•c ƒë√≠ch ƒë√°nh gi√° ', 'purpose', 'mucdich', 'muc_dich', 'm·ª•c ƒë√≠ch ƒë√°nh gi√°', 'muc dich danh gia', 'mucdichdanhgia']));
        addTd(tr, getV(item, ['note', 'ghi_chu', 'ghichu']));
        addTd(tr, getV(item, ['specialtest', 'yeucau_test_dac_biet', 'yeu_cau_test_dac_biet']));
        addTd(tr, getV(item, ['reportform', 'form_bao_cao', 'form_bao_cao_danh_gia']));
        addTd(tr, getV(item, ['attachmentfilename', 'file_name', 'filename', 'tenfile', 'ten_file', 't√™n file', 't√™n file ƒë√≠nh k√®m', 'attachment', 'file']));

        // Highlight theo h·∫°n mong mu·ªën cho t√°c v·ª• Doing
        try {
          const wishDueStr = getV(item, ['H·∫°n mong mu·ªën ', 'wishdue', 'hanmongmuon', 'han_mong_muon', 'desireddue', 'h·∫°n mong mu·ªën']);
          if (isDoing && wishDueStr) {
            const dueDate = parseDateFlexible(wishDueStr);
            if (!isNaN(dueDate.getTime())) {
              const ymd = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
              const today = new Date();
              const dueYmd = ymd(dueDate);
              const todayYmd = ymd(today);
              if (dueYmd < todayYmd) {
                tr.style.backgroundColor = '#FEE2E2'; // ƒë·ªè nh·∫°t
              } else if (dueYmd === todayYmd) {
                tr.style.backgroundColor = '#FEF3C7'; // v√†ng nh·∫°t
              }
            }
          }
        } catch(_) {}

        F1_ALL_ROWS.push(tr);
      });

      applyForm1Paging();
    }

    function fetchWithTimeout(resource, options = {}){
      const { timeout = 120000 } = options;
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(()=>clearTimeout(id));
    }

    async function renderForm1(){
      const unassigned = F1_UNASSIGNED_MODE === true;
      const nameSelected = (document.getElementById('f1-name').value || '').trim();
      const personParam = unassigned ? '' : nameSelected;
      const body = document.getElementById('f1-body');
      if(!unassigned && !nameSelected){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'N√∫t nh·∫≠p g·ª≠i b√°o c√°o',
          header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_code: 'M√£',
          header_taskName: 'T√™n t√°c v·ª•',
            header_manHour: 'C√¥ng chu·∫©n',
          header_purpose: 'M·ª•c ƒë√≠ch ƒë√°nh gi√°',
          header_note: 'Note',
          header_specialTest: 'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát',
          header_reportForm: 'Form b√°o c√°o ƒë√°nh gi√°',
          header_status: 'Tr·∫°ng th√°i',
          header_completionDate: 'Ng√†y ho√†n th√†nh th·ª±c t·∫ø',
          header_attachmentFileName: 'T√™n file ƒë√≠nh k√®m',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
            field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_completionDate: 'completionDate',
          field_attachmentFileName: 'attachmentFileName'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: personParam,
          timestamp: formatTimestampGMT7()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          // Retry nh·∫π: t·ªëi ƒëa 2 l·∫ßn khi l·ªói m·∫°ng/timeout
          const maxAttempts = 2;
          let lastErr = null;
          for (let attempt = 1; attempt <= maxAttempts; attempt++){
            try{
              const r = await fetchWithTimeout(url, { 
                method: 'GET', 
                timeout: 120000,
                mode: 'cors',
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Content-Type': 'application/json'
                }
              });
              const text = await r.text();
              if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
              let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
              return { parsed, raw: text };
            }catch(e){
              lastErr = e;
              if (attempt < maxAttempts) {
                // ch·ªù ng·∫Øn tr∆∞·ªõc l·∫ßn th·ª≠ ti·∫øp
                await new Promise(res=>setTimeout(res, 1000));
                continue;
              }
              throw lastErr;
            }
          }
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook ch∆∞a b·∫≠t l·∫Øng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          try {
            const { parsed, raw } = await fetchJson(prodUrl);
            data = parsed ?? raw;
          } catch (e2) {
            // N·∫øu c·∫£ hai ƒë·ªÅu fail, th·ª≠ v·ªõi proxy CORS
            console.log('[Form1 Debug] Direct fetch failed, trying CORS proxy');
            const proxyUrls = [
              `https://api.allorigins.win/raw?url=${encodeURIComponent(prodUrl)}`,
              `https://cors.isomorphic-git.org/${prodUrl}`,
              `https://cors-anywhere.herokuapp.com/${prodUrl}`,
              `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(prodUrl)}`
            ];
            
            for (const proxyUrl of proxyUrls) {
              try {
                console.log('[Form1 Debug] Trying proxy:', proxyUrl);
                const { parsed, raw } = await fetchJson(proxyUrl);
                data = parsed ?? raw;
                break;
              } catch (e3) {
                console.log('[Form1 Debug] Proxy failed:', e3.message);
                continue;
              }
            }
            
            if (!data) {
              throw e2; // Throw original error if all proxies fail
            }
          }
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        let rows = pickRows(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // L·ªçc b·ªè c√°c d√≤ng kh√¥ng c√≥ T√™n t√°c v·ª• (tr√°nh r·ªóng th√¥ng tin)
        rows = rows.filter(item=> String(getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•'])||'').trim() !== '');
        if(!rows.length){ body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
        
        // L∆∞u d·ªØ li·ªáu g·ªëc ƒë·ªÉ l·ªçc c·ª•c b·ªô
        F1_ALL_DATA = [...rows];
        
        // √Åp d·ª•ng l·ªçc c·ª•c b·ªô
        applyLocalMonthFilter();
      }catch(err){
        const isCors = /Failed to fetch|CORS|No 'Access-Control-Allow-Origin'|NetworkError|TypeError/.test(String(err && (err.message || err)));
        const msg = isCors
          ? 'B·ªã ch·∫∑n b·ªüi CORS. ƒê√£ th·ª≠ nhi·ªÅu proxy nh∆∞ng v·∫´n kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng m·ªü file qua web server (vd: Live Server) ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.'
          : (String(err && err.name)==='AbortError') ? 'Qu√° th·ªùi gian ch·ªù (120s). Vui l√≤ng th·ª≠ l·∫°i.' : `L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}`;
        body.innerHTML = `<tr><td colspan='15' class='px-3 py-3 text-center text-red-600'>${msg}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { F1_UNASSIGNED_MODE = false; await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // N√∫t l·ªçc c√°c t√°c v·ª• ch∆∞a ƒë∆∞·ª£c ph√¢n c√¥ng (t√™n tr·ªëng)
    const f1UnassignedBtn = document.getElementById('f1-unassigned');
    if (f1UnassignedBtn) {
      let f1UBusy = false;
      f1UnassignedBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1UBusy) return;
        f1UBusy = true;
        F1_UNASSIGNED_MODE = true;
        f1UnassignedBtn.disabled = true;
        const prev = f1UnassignedBtn.textContent;
        f1UnassignedBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { await renderForm1(); }
        finally {
          f1UBusy = false;
          f1UnassignedBtn.disabled = false;
          f1UnassignedBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'10',10)||10; F1_PAGE=1; applyForm1Paging(); };

    // Month filter events - ch·ªâ l·ªçc c·ª•c b·ªô, kh√¥ng g·ªçi server
    const f1Month = document.getElementById('f1-month');
    const f1ClearFilter = document.getElementById('f1-clear-filter');
    
    if (f1Month) {
      f1Month.addEventListener('change', (e) => {
        F1_MONTH_FILTER = e.target.value || '';
        F1_PAGE = 1; // Reset v·ªÅ trang ƒë·∫ßu khi thay ƒë·ªïi b·ªô l·ªçc
        applyLocalMonthFilter(); // Ch·ªâ l·ªçc c·ª•c b·ªô
      });
    }
    
    if (f1ClearFilter) {
      f1ClearFilter.addEventListener('click', (e) => {
        e.preventDefault();
        F1_MONTH_FILTER = '';
        if (f1Month) f1Month.value = '';
        F1_PAGE = 1; // Reset v·ªÅ trang ƒë·∫ßu khi x√≥a b·ªô l·ªçc
        applyLocalMonthFilter(); // Ch·ªâ l·ªçc c·ª•c b·ªô
      });
    }




    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('ƒê√£ copy li√™n k·∫øt.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }

    // ===== Form 2: T·∫•t c·∫£ t√°c v·ª• =====
    let F2_ALL_DATA = [];
    let F2_MONTH_FILTER = '';
    let F2_EMPLOYEE_STATS = {}; // L∆∞u th·ªëng k√™ theo nh√¢n vi√™n

    // Form 2: Month filter
    const f2Month = document.getElementById('f2-month');
    if (f2Month) {
      // Set default month to current month
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      f2Month.value = `${year}-${month}`;
      F2_MONTH_FILTER = f2Month.value;

      f2Month.addEventListener('change', (e) => {
        F2_MONTH_FILTER = e.target.value || '';
        console.log('[Form2 Debug] Month changed to:', F2_MONTH_FILTER);
        console.log('[Form2 Debug] F2_ALL_DATA length:', F2_ALL_DATA.length);
        // D√πng d·ªØ li·ªáu hi·ªán c√≥, kh√¥ng g·ªçi l·∫°i server
        if (F2_ALL_DATA.length > 0) {
          calculateEmployeeStats(F2_ALL_DATA);
          renderForm2Stats();
          console.log('[Form2 Debug] Stats recalculated and rendered');
        } else {
          console.log('[Form2 Debug] No data available for recalculation');
        }
      });
    }

    // Form 2: Fetch data from same source as Form 1
    async function fetchForm2Data() {
      const body = document.getElementById('f2-body-p1');
      if (!body) return;

      body.innerHTML = "<tr><td colspan='10' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";

      try {
        const headerMapF2 = {
          // Headers cho modal (15 c·ªôt)
          header_btn: 'N√∫t nh·∫≠p g·ª≠i b√°o c√°o',
          header_status: 'T√¨nh tr·∫°ng',
          header_completionDate: 'Ng√†y ho√†n th√†nh th·ª±c t·∫ø',
          header_code: 'M√£',
          header_taskName: 'T√™n t√°c v·ª•',
          header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
          header_manHour: 'C√¥ng chu·∫©n',
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_purpose: 'M·ª•c ƒë√≠ch ƒë√°nh gi√°',
          header_note: 'Note',
          header_specialTest: 'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát',
          header_reportForm: 'Form b√°o c√°o ƒë√°nh gi√°',
          header_attachmentFileName: 'T√™n file ƒë√≠nh k√®m',
          
          // Field mappings cho modal
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
          field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_completionDate: 'completionDate',
          field_attachmentFileName: 'attachmentFileName',
          
          // Additional fields for comprehensive data
          field_assignee: 'assignee',
          field_progress: 'progress',
          field_priority: 'priority',
          field_category: 'category',
          field_department: 'department',
          field_project: 'project',
          field_estimatedHours: 'estimatedHours',
          field_actualHours: 'actualHours',
          field_createdDate: 'createdDate',
          field_updatedDate: 'updatedDate',
          field_createdBy: 'createdBy',
          field_updatedBy: 'updatedBy',
          field_tags: 'tags',
          field_comments: 'comments',
          field_attachments: 'attachments',
          field_relatedTasks: 'relatedTasks',
          field_dependencies: 'dependencies',
          field_riskLevel: 'riskLevel',
          field_complexity: 'complexity',
          field_qualityScore: 'qualityScore',
          field_feedback: 'feedback',
          field_lessonsLearned: 'lessonsLearned',
          field_nextSteps: 'nextSteps',
          field_resources: 'resources',
          field_tools: 'tools',
          field_methodology: 'methodology',
          field_standards: 'standards',
          field_compliance: 'compliance',
          field_approvalStatus: 'approvalStatus',
          field_approver: 'approver',
          field_approvalDate: 'approvalDate',
          field_reviewStatus: 'reviewStatus',
          field_reviewer: 'reviewer',
          field_reviewDate: 'reviewDate',
          field_testStatus: 'testStatus',
          field_tester: 'tester',
          field_testDate: 'testDate',
          field_deploymentStatus: 'deploymentStatus',
          field_deploymentDate: 'deploymentDate',
          field_performance: 'performance',
          field_metrics: 'metrics',
          field_kpis: 'kpis',
          field_sla: 'sla',
          field_budget: 'budget',
          field_cost: 'cost',
          field_roi: 'roi',
          field_impact: 'impact',
          field_benefits: 'benefits',
          field_challenges: 'challenges',
          field_solutions: 'solutions',
          field_recommendations: 'recommendations'
        };

        // L·∫•y t√™n ng∆∞·ªùi hi·ªán t·∫°i (c√≥ th·ªÉ t·ª´ Form 1 ho·∫∑c m·∫∑c ƒë·ªãnh)
        const currentPersonName = (document.getElementById('f1-name')?.value || '').trim() || 'T·∫•t c·∫£';
        
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_all_tasks', // Action ri√™ng cho Form 2
          person_name: currentPersonName, // Th√™m t√™n ng∆∞·ªùi v√†o query
          month: F2_MONTH_FILTER || '',
          timestamp: formatTimestampGMT7()
        });

        const baseUrl = `${FORM2_WEBHOOK_URL}?${params.toString()}`;

        async function fetchJsonWithProxyChain(base) {
        // Th·ª≠ JSONP tr∆∞·ªõc (ho·∫°t ƒë·ªông v·ªõi file://)
        const jsonpPromise = new Promise((resolve, reject) => {
          const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
          const script = document.createElement('script');
          const url = base + (base.includes('?') ? '&' : '?') + 'callback=' + callbackName;
          
          window[callbackName] = function(data) {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve({ parsed: data, source: 'jsonp' });
          };
          
          script.onerror = function() {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('JSONP_FAILED'));
          };
          
          script.src = url;
          document.head.appendChild(script);
          
          // Timeout sau 30 gi√¢y
          setTimeout(() => {
            if (document.head.contains(script)) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('JSONP_TIMEOUT'));
            }
          }, 30000);
        });

        try {
          console.log('[Form2 Debug] Trying JSONP:', base);
          const result = await jsonpPromise;
          if (result.parsed && hasMeaningfulRows(result.parsed)) {
            return result;
          }
        } catch (e) {
          console.log('[Form2 Debug] JSONP failed:', e.message);
        }

        // Fallback: Th·ª≠ fetch tr·ª±c ti·∫øp nh∆∞ Form 5
        const urlProd = base.includes('/webhook/') ? base : base.replace('/webhook-test/', '/webhook/');
        const urlTest = base.includes('/webhook-test/') ? base : base.replace('/webhook/', '/webhook-test/');
        const urls = [urlTest, urlProd];
        
        let lastErr = null;
        const hasMeaningfulRows = (obj)=>{
          if (Array.isArray(obj)) return obj.length > 0 && typeof obj[0] === 'object';
          if (!obj || typeof obj !== 'object') return false;
          const keys = ['data','rows','result','records','items','list'];
          for (const k of keys) {
            const v = obj[k];
            if (Array.isArray(v) && v.length && typeof v[0] === 'object') return true;
          }
          try {
            for (const v of Object.values(obj)) {
              if (Array.isArray(v) && v.length && typeof v[0] === 'object') return true;
            }
          } catch(_){}
          return false;
        };

        for (const url of urls) {
          try {
            console.log('[Form2 Debug] Fetching:', url);
            const r = await fetch(url, { 
              method: 'GET',
              headers: {
                'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json'
              }
            });
            const text = await r.text();
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
            if (!text || text.trim().length === 0) throw new Error('EMPTY_RESPONSE');
            
            let parsed = null;
            try { parsed = JSON.parse(text); } catch { parsed = null; }
            
            if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
              throw new Error('WEBHOOK_TEST_INACTIVE');
            }
            if (!parsed) throw new Error('INVALID_JSON');
            if (!hasMeaningfulRows(parsed)) throw new Error('NO_ROWS_FOUND');
            return { parsed, source: url };
          } catch (e) {
            lastErr = e;
            console.log('[Form2 Debug] Fetch failed:', e.message);
            continue;
          }
        }
        throw lastErr || new Error('FETCH_FAILED');
        }

        let data = null; let sourceUsed = '';
        try {
          const result = await fetchJsonWithProxyChain(baseUrl);
          data = result.parsed; sourceUsed = result.source;
        } catch (e) {
          throw e;
        }

        function pickRows(json) {
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data', 'rows', 'result', 'records', 'items', 'list'];
          for (const k of candidates) { if (Array.isArray(json?.[k])) return json[k]; }
          try {
            const queue = [json];
            const seen = new Set();
            while (queue.length) {
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)) {
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          } catch (_) { }
          return [];
        }

        let rows = pickRows(data);
        console.log('[Form2 Debug] Raw data received:', Array.isArray(data) ? `Array(${data.length})` : (data && typeof data === 'object' ? 'Object' : typeof data), 'from:', sourceUsed || 'unknown');
        console.log('[Form2 Debug] Extracted rows count:', rows.length);
        console.log('[Form2 Debug] First few rows:', rows.slice(0, 3));
        
        // Khai b√°o getV function tr∆∞·ªõc khi s·ª≠ d·ª•ng
        const getV = (obj, keys) => {
          const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
          for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
          return '';
        };
        
        // (Ho√£n) Kh√¥ng l∆∞u d·ªØ li·ªáu g·ªëc tr∆∞·ªõc khi filter ƒë·ªÉ tr√°nh sai l·ªách khi t√°i t√≠nh theo th√°ng
        
        // Debug: Ki·ªÉm tra completionDate trong d·ªØ li·ªáu
        console.log('[Form2 Debug] Sample completionDate values:');
        let completionDateCount = 0;
        rows.slice(0, 5).forEach((item, index) => {
          const completionDate = getV(item, [
            'Ng√†y ho√†n th√†nh th·ª±c t·∫ø', 'ng√†y ho√†n th√†nh th·ª±c t·∫ø',
            'completionDate', 'completiondate', 'completedDate', 'completeddate',
            'completion_date', 'completed_date', 'done_date',
            'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay_hoan_thanh_thuc_te'
          ]);
          console.log(`[Form2 Debug] Row ${index}:`, completionDate);
          if (completionDate) completionDateCount++;
        });
        
        // ƒê·∫øm t·ªïng s·ªë completionDate trong to√†n b·ªô d·ªØ li·ªáu
        const totalCompletionDates = rows.filter(item => {
          const completionDate = getV(item, [
            'Ng√†y ho√†n th√†nh th·ª±c t·∫ø', 'ng√†y ho√†n th√†nh th·ª±c t·∫ø',
            'completionDate', 'completiondate', 'completedDate', 'completeddate',
            'completion_date', 'completed_date', 'done_date',
            'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay_hoan_thanh_thuc_te'
          ]);
          return completionDate && String(completionDate).trim() !== '';
        }).length;
        console.log('[Form2 Debug] Total rows with completionDate:', totalCompletionDates, 'out of', rows.length);
        
        if (!rows.length) {
          console.log('[Form2 Debug] No rows found, showing empty message');
          body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>";
          return;
        }

        // L·ªçc b·ªè c√°c d√≤ng kh√¥ng c√≥ T√™n t√°c v·ª• (b·ªï sung 'Task Name')
        rows = rows.filter(item => String(getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 't√™n t√°c v·ª•']) || '').trim() !== '');
        if (!rows.length) {
          body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>";
          return;
        }

        // L∆∞u d·ªØ li·ªáu g·ªëc SAU KHI filter ƒë·ªÉ ƒë·ªìng b·ªô t√°i t√≠nh khi ƒë·ªïi th√°ng
        F2_ALL_DATA = [...rows];
        console.log('[Form2 Debug] F2_ALL_DATA (filtered) saved with', F2_ALL_DATA.length, 'rows');

        // T√≠nh to√°n th·ªëng k√™ theo nh√¢n vi√™n
        calculateEmployeeStats(rows);
        
        // Render b·∫£ng th·ªëng k√™
        renderForm2Stats();
        
      } catch (err) {
        const isCors = /Failed to fetch|CORS|No 'Access-Control-Allow-Origin'|NetworkError|TypeError|JSONP_FAILED|JSONP_TIMEOUT/.test(String(err && (err.message || err)));
        const msg = isCors
          ? 'B·ªã ch·∫∑n b·ªüi CORS. ƒê√£ th·ª≠ JSONP v√† fetch tr·ª±c ti·∫øp nh∆∞ng v·∫´n kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng m·ªü file qua web server (vd: Live Server) ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.'
          : (String(err && err.name) === 'AbortError')
            ? 'Qu√° th·ªùi gian ch·ªù (120s). Vui l√≤ng th·ª≠ l·∫°i.'
            : `L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message || err)}`;
        
        body.innerHTML = `<tr><td colspan='11' class='px-3 py-3 text-center text-red-600'>${msg}</td></tr>`;
      }
    }

    // Parser ng√†y linh ho·∫°t: h·ªó tr·ª£ YYYY-MM-DD[ HH:mm[:ss]], DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY, YYYY/MM/DD
    function parseDateFlexible(input){
      const s = String(input || '').trim();
      if (!s) return new Date('');
      // ISO-like or YYYY-MM-DD
      let m = s.match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/);
      if (m) {
        const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
        const hh = parseInt(m[4]||'0',10), mm = parseInt(m[5]||'0',10), ss = parseInt(m[6]||'0',10);
        return new Date(y, mo, d, hh, mm, ss);
      }
      // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
      m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/);
      if (m) {
        const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
        const hh = parseInt(m[4]||'0',10), mm = parseInt(m[5]||'0',10), ss = parseInt(m[6]||'0',10);
        return new Date(y, mo, d, hh, mm, ss);
      }
      // Fallback native
      const dt = new Date(s);
      return dt;
    }

    // T√≠nh to√°n th·ªëng k√™ theo nh√¢n vi√™n
    function calculateEmployeeStats(rows) {
      console.log('[Form2 Debug] calculateEmployeeStats called with F2_MONTH_FILTER:', F2_MONTH_FILTER);
      F2_EMPLOYEE_STATS = {};
      
      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      // Chu·∫©n ho√° chu·ªói: b·ªè d·∫•u ti·∫øng Vi·ªát, lo·∫°i b·ªè kho·∫£ng tr·∫Øng/thanh n·ªëi ƒë·ªÉ so kh·ªõp m·ªÅm
      const normalize = (s) => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .replace(/\s|_/g, '');

      // T√¨m field Ng√†y ho√†n th√†nh th·ª±c t·∫ø theo nhi·ªÅu bi·∫øn th·ªÉ t√™n c·ªôt
      const getCompletionDateFromItem = (item) => {
        // 1) Th·ª≠ c√°c key ph·ªï bi·∫øn (∆∞u ti√™n)
        const valDirect = getV(item, [
          'Ng√†y ho√†n th√†nh th·ª±c t·∫ø', 'ng√†y ho√†n th√†nh th·ª±c t·∫ø',
          'Ng√†y ho√†n th√†nh', 'ng√†y ho√†n th√†nh',
          'completionDate', 'completiondate', 'completedDate', 'completeddate',
          'completion_date', 'completed_date', 'done_date',
          'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay hoan thanh',
          'ngay_hoan_thanh_thuc_te', 'ngay hoan thanh thuc te'
        ]);
        if (valDirect) return valDirect;

        // 2) So kh·ªõp m·ªÅm: key ch·ª©a t·ª´ kho√° "hoanthanh|completed|completion|done" v√† ƒë·ªìng th·ªùi ch·ª©a "ngay|date"
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasComplete = /(hoanthanh|completed?|completion|done)/.test(nk);
            const hasDate = /(ngay|date)/.test(nk);
            if (hasComplete && hasDate) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // T√¨m field Ng√†y y√™u c·∫ßu (request date) theo nhi·ªÅu bi·∫øn th·ªÉ t√™n c·ªôt
      const getRequestDateFromItem = (item) => {
        const valDirect = getV(item, [
          'üìÜ Ng√†y y√™u c·∫ßu ', 'Ng√†y y√™u c·∫ßu', 'ng√†y y√™u c·∫ßu',
          'requestDate', 'requestdate', 'submissiondate',
          'ngayyeucau', 'ngay_yeu_cau', 'ngay gui', 'ngaygui'
        ]);
        if (valDirect) return valDirect;
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasReq = /(yeucau|request|submit|submission)/.test(nk);
            const hasDate = /(ngay|date)/.test(nk);
            if (hasReq && hasDate) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // T√¨m field H·∫°n mong mu·ªën (wish due) theo nhi·ªÅu bi·∫øn th·ªÉ t√™n c·ªôt
      const getWishDueFromItem = (item) => {
        const valDirect = getV(item, [
          'H·∫°n mong mu·ªën ', 'H·∫°n mong mu·ªën', 'h·∫°n mong mu·ªën',
          'wishDue', 'wishdue', 'desireddue',
          'hanmongmuon', 'han_mong_muon'
        ]);
        if (valDirect) return valDirect;
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasWish = /(mongmuon|wish|desire)/.test(nk);
            const hasDue = /(han|due|deadline)/.test(nk);
            if (hasWish && hasDue) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Kh·ªüi t·∫°o th·ªëng k√™ cho t·∫•t c·∫£ nh√¢n vi√™n trong danh s√°ch Form 2
      FORM2_NAMES.forEach(name => {
        F2_EMPLOYEE_STATS[name] = {
          name: name,
          totalTasks: 0, // T·ªïng s·ªë t√°c v·ª• ƒëang th·ª±c hi·ªán (Doing)
          done: 0, // S·ªë Done trong th√°ng ƒë∆∞·ª£c ch·ªçn
          ahead: 0,
          ontime: 0,
          late: 0,
          na: 0,
          tasks: []
        };
      });

      rows.forEach(item => {
        // S·ª≠ d·ª•ng danh s√°ch fallback keys gi·ªëng Form 5
        const assignee = getV(item, [
          'Assignee', 'Assignee Name', 'AssigneeName', 'Assignee name',
          'Ph·ª• tr√°ch', 'Ph·ª• tr√°ch ch√≠nh', 'Ng∆∞·ªùi ph·ª• tr√°ch', 'Ng∆∞·ªùi x·ª≠ l√Ω', 'Ng∆∞·ªùi nh·∫≠n m·∫´u', 'Ng∆∞·ªùi nh·∫≠n',
          'employee', 'nhanvien', 'nhan_vien', 'nh√¢n vi√™n', 'user', 'name', 'receiver', 'recipient', 'pic', 'nguoi_phu_trach', 'ng∆∞·ªùi ph·ª• tr√°ch',
          'assignee', 'nguoi_nhan', 'ng∆∞·ªùi nh·∫≠n', 'nguoi_thuc_hien', 'ng∆∞·ªùi th·ª±c hi·ªán', 'name_1', 'Name 1'
        ]);
        
        if (!assignee || assignee.trim() === '') {
          return;
        }

        // N·∫øu t√™n kh√¥ng c√≥ trong danh s√°ch, t·∫°o m·ªõi ƒë·ªÉ kh√¥ng b·ªè s√≥t d·ªØ li·ªáu
        if (!F2_EMPLOYEE_STATS[assignee]) {
          F2_EMPLOYEE_STATS[assignee] = {
            name: assignee,
            totalTasks: 0, // T·ªïng s·ªë t√°c v·ª• ƒëang th·ª±c hi·ªán (Doing)
            done: 0, // S·ªë Done trong th√°ng ƒë∆∞·ª£c ch·ªçn
            ahead: 0,
            ontime: 0,
            late: 0,
            na: 0,
            tasks: []
          };
        }

        // ƒê·∫øm t·ªïng s·ªë t√°c v·ª• ƒëang th·ª±c hi·ªán (ch·ªâ tr·∫°ng th√°i Doing)
        const status = getV(item, ['‚ÅâÔ∏è K·∫øt qu·∫£', 'status', 'trangthai', 'trang_thai', 'tr·∫°ng th√°i', 'ket_qua', 'result']);
        const statusLower = (status || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('ƒëang');
        
        if (isDoing) {
          F2_EMPLOYEE_STATS[assignee].totalTasks++;
        }

        const isDone = statusLower.includes('ho√†n') || statusLower.includes('done');
        
        // T√≠nh to√°n ti·∫øn ƒë·ªô
        const requestDate = getRequestDateFromItem(item);
        const wishDue = getWishDueFromItem(item);
        const completionDate = getCompletionDateFromItem(item);
        
        // ƒê·∫øm Done trong ph·∫°m vi th√°ng ƒëang l·ªçc (ho·∫∑c t·∫•t c·∫£ n·∫øu kh√¥ng l·ªçc) v√† ch·ªâ ph√¢n lo·∫°i cho nh·ªØng t√°c v·ª• ƒë∆∞·ª£c ƒë·∫øm
        let isCountedDone = false;
        if (completionDate) {
          const compDate = parseDateFlexible(completionDate);
          if (!isNaN(compDate.getTime())) {
            if (F2_MONTH_FILTER) {
              const compYear = compDate.getFullYear();
              const compMonth = String(compDate.getMonth() + 1).padStart(2, '0');
              const compMonthStr = `${compYear}-${compMonth}`;
              if (compMonthStr === F2_MONTH_FILTER) {
                F2_EMPLOYEE_STATS[assignee].done++;
                isCountedDone = true;
              }
            } else {
              F2_EMPLOYEE_STATS[assignee].done++;
              isCountedDone = true;
            }
          }
        }

        // Ch·ªâ t√≠nh V∆∞·ª£t/ƒê√∫ng/Ch·∫≠m/N/A cho c√°c t√°c v·ª• Done ƒë√£ ƒë∆∞·ª£c t√≠nh v√†o m·∫´u s·ªë (isCountedDone)
        if (isCountedDone) {
          if (requestDate && wishDue && completionDate) {
            const reqDate = parseDateFlexible(requestDate);
            const wishDate = parseDateFlexible(wishDue);
            const compDate = parseDateFlexible(completionDate);
            if (!isNaN(reqDate.getTime()) && !isNaN(wishDate.getTime()) && !isNaN(compDate.getTime())) {
              const daysDiff = (compDate.getTime() - wishDate.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff < 0) {
                F2_EMPLOYEE_STATS[assignee].ahead++;
              } else if (daysDiff <= 1) {
                F2_EMPLOYEE_STATS[assignee].ontime++;
              } else {
                F2_EMPLOYEE_STATS[assignee].late++;
              }
            } else {
              F2_EMPLOYEE_STATS[assignee].na++;
            }
          } else {
            F2_EMPLOYEE_STATS[assignee].na++;
          }
        }

        // L∆∞u th√¥ng tin t√°c v·ª• ƒë·∫ßy ƒë·ªß cho modal v·ªõi mapping JSON m·ªõi
        const reqDateStr = getRequestDateFromItem(item);
        const wishDueStr = getWishDueFromItem(item);
        const completionDateStr = getCompletionDateFromItem(item);
        F2_EMPLOYEE_STATS[assignee].tasks.push({
          // Core fields cho modal (8 c·ªôt) - Mapping ch√≠nh x√°c theo y√™u c·∫ßu
          code: getV(item, ['üÜî M√£ B√°o c√°o', 'M√£ t√°c v·ª•', 'code', 'ma', 'taskcode', 'm√£', 'm√£_b√°o_c√°o']),
          taskName: getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 't√™n t√°c v·ª•']),
          requester: getV(item, ['Ng∆∞·ªùi y√™u c·∫ßu', 'üñäÔ∏è T√™n NCC ', 'requester', 'nguoiyeucau', 'nguoi_yeu_cau', 'assigner', 'ng∆∞·ªùi y√™u c·∫ßu']),
          requestDate: reqDateStr,
          wishDue: wishDueStr,
          note: getV(item, ['Ghi ch√∫', 'note', 'ghi_chu', 'ghichu', 'comments', 'b√¨nh_lu·∫≠n']),
          completionDate: completionDateStr,
          status: status,
          progress: calculateProgress(reqDateStr, wishDueStr, completionDateStr),
          
          // Additional fields t·ª´ JSON m·ªõi
          assigneeField: getV(item, ['Assignee', 'assignee', 'nguoi_nhan', 'ng∆∞·ªùi nh·∫≠n', 'nguoi_thuc_hien', 'ng∆∞·ªùi th·ª±c hi·ªán']),
          emailAssigner: getV(item, ['Email Assigner', 'email_assigner', 'email_nguoi_yeu_cau']),
          emailAssignee: getV(item, ['EmailofAssignee', 'email_assignee', 'email_nguoi_thuc_hien']),
          telegramMsgId: getV(item, ['TelegramMsgId', 'telegram_msg_id', 'telegram_message_id']),
          linkCongViec: getV(item, ['Link C√¥ng Vi·ªác', 'link_cong_viec', 'link_work']),
          logGuiCongViec: getV(item, ['Log g·ª≠i c√¥ng vi·ªác', 'log_gui_cong_viec', 'log_send_work']),
          ketQua: getV(item, ['‚ÅâÔ∏è K·∫øt qu·∫£', 'ket_qua', 'result', 'status']),
          maBaoCao: getV(item, ['üÜî M√£ B√°o c√°o', 'ma_bao_cao', 'report_code', 'report_id']),
          emailId: getV(item, ['Email ID', 'email_id']),
          name1: getV(item, ['Name 1', 'name_1', 'nguoi_thuc_hien']),
          email1: getV(item, ['Email 1', 'email_1']),
          linkBC: getV(item, ['LinkBC', 'link_bc', 'link_bao_cao']),
          nhanXetTruongNhom: getV(item, ['Nh·∫≠n x√©t tr∆∞·ªüng nh√≥m', 'nhan_xet_truong_nhom', 'team_lead_comment']),
          ngayBoSung: getV(item, ['Ng√†y b·ªï sung', 'ngay_bo_sung', 'supplement_date']),
          maPheDuyet: getV(item, ['M√£ ph√™ duy·ªát', 'ma_phe_duyet', 'approval_code']),
          nhanXetTruongPhong: getV(item, ['Nh·∫≠n x√©t tr∆∞·ªüng ph√≤ng', 'nhan_xet_truong_phong', 'department_head_comment']),
          
          // Test fields t·ª´ JSON
          ghiChu2a: getV(item, ['Ghi ch√∫ 2a', 'ghi_chu_2a']),
          diemNG3a: getV(item, ['3a ƒêi·ªÉm NG ', 'diem_ng_3a', 'point_ng_3a']),
          ghiChu3a: getV(item, ['Ghi ch√∫ 3a', 'ghi_chu_3a']),
          testBen4a: getV(item, ['4a Test b·ªÅn ', 'test_ben_4a', 'durability_test_4a']),
          ghiChu4a: getV(item, ['Ghi ch√∫ 4a', 'ghi_chu_4a']),
          baiTestKhac5a: getV(item, ['5a B√†i test kh√°c', 'bai_test_khac_5a', 'other_test_5a']),
          ghiChu5a: getV(item, ['Ghi ch√∫ 5a', 'ghi_chu_5a']),
          fileAttachment: getV(item, ['File attachment ', 'file_attachment', 'attachment_file']),
          
          // Additional comprehensive fields
          assignee: assignee,
          priority: getV(item, ['priority', 'ƒë·ªô_∆∞u_ti√™n', 'do_uu_tien', 'm·ª©c_ƒë·ªô_quan_tr·ªçng']),
          category: getV(item, ['category', 'lo·∫°i', 'loai', 'ph√¢n_lo·∫°i', 'phan_loai']),
          department: getV(item, ['department', 'ph√≤ng_ban', 'phong_ban', 'b·ªô_ph·∫≠n', 'bo_phan']),
          project: getV(item, ['project', 'd·ª±_√°n', 'du_an', 'd·ª±_√°n', 'du_an']),
          estimatedHours: getV(item, ['estimatedHours', 'estimated_hours', 'gi·ªù_∆∞·ªõc_t√≠nh', 'gio_uoc_tinh']),
          actualHours: getV(item, ['actualHours', 'actual_hours', 'gi·ªù_th·ª±c_t·∫ø', 'gio_thuc_te']),
          createdDate: getV(item, ['createdDate', 'created_date', 'ng√†y_t·∫°o', 'ngay_tao']),
          updatedDate: getV(item, ['updatedDate', 'updated_date', 'ng√†y_c·∫≠p_nh·∫≠t', 'ngay_cap_nhat']),
          createdBy: getV(item, ['createdBy', 'created_by', 'ng∆∞·ªùi_t·∫°o', 'nguoi_tao']),
          updatedBy: getV(item, ['updatedBy', 'updated_by', 'ng∆∞·ªùi_c·∫≠p_nh·∫≠t', 'nguoi_cap_nhat']),
          tags: getV(item, ['tags', 'th·∫ª', 'the', 'nh√£n', 'nhan']),
          comments: getV(item, ['comments', 'b√¨nh_lu·∫≠n', 'binh_luan', 'ghi_ch√∫', 'ghi_chu']),
          attachments: getV(item, ['attachments', 't·ªáp_ƒë√≠nh_k√®m', 'tep_dinh_kem', 'file_attachments']),
          relatedTasks: getV(item, ['relatedTasks', 'related_tasks', 't√°c_v·ª•_li√™n_quan', 'tac_vu_lien_quan']),
          dependencies: getV(item, ['dependencies', 'ph·ª•_thu·ªôc', 'phu_thuoc', 'r√†ng_bu·ªôc', 'rang_buoc']),
          riskLevel: getV(item, ['riskLevel', 'risk_level', 'm·ª©c_ƒë·ªô_r·ªßi_ro', 'muc_do_rui_ro']),
          complexity: getV(item, ['complexity', 'ƒë·ªô_ph·ª©c_t·∫°p', 'do_phuc_tap', 'm·ª©c_ƒë·ªô_ph·ª©c_t·∫°p']),
          qualityScore: getV(item, ['qualityScore', 'quality_score', 'ƒëi·ªÉm_ch·∫•t_l∆∞·ª£ng', 'diem_chat_luong']),
          feedback: getV(item, ['feedback', 'ph·∫£n_h·ªìi', 'phan_hoi', 'ƒë√°nh_gi√°', 'danh_gia']),
          lessonsLearned: getV(item, ['lessonsLearned', 'lessons_learned', 'b√†i_h·ªçc', 'bai_hoc', 'kinh_nghi·ªám']),
          nextSteps: getV(item, ['nextSteps', 'next_steps', 'b∆∞·ªõc_ti·∫øp_theo', 'buoc_tiep_theo']),
          resources: getV(item, ['resources', 't√†i_nguy√™n', 'tai_nguyen', 'ngu·ªìn_l·ª±c', 'nguon_luc']),
          tools: getV(item, ['tools', 'c√¥ng_c·ª•', 'cong_cu', 'd·ª•ng_c·ª•', 'dung_cu']),
          methodology: getV(item, ['methodology', 'ph∆∞∆°ng_ph√°p', 'phuong_phap', 'quy_tr√¨nh', 'quy_trinh']),
          standards: getV(item, ['standards', 'ti√™u_chu·∫©n', 'tieu_chuan', 'chu·∫©n_m·ª±c', 'chuan_muc']),
          compliance: getV(item, ['compliance', 'tu√¢n_th·ªß', 'tuan_thu', 'tu√¢n_th·ªß_quy_ƒë·ªãnh']),
          approvalStatus: getV(item, ['approvalStatus', 'approval_status', 'tr·∫°ng_th√°i_ph√™_duy·ªát', 'trang_thai_phe_duyet']),
          approver: getV(item, ['approver', 'ng∆∞·ªùi_ph√™_duy·ªát', 'nguoi_phe_duyet', 'ng∆∞·ªùi_duy·ªát']),
          approvalDate: getV(item, ['approvalDate', 'approval_date', 'ng√†y_ph√™_duy·ªát', 'ngay_phe_duyet']),
          reviewStatus: getV(item, ['reviewStatus', 'review_status', 'tr·∫°ng_th√°i_ƒë√°nh_gi√°', 'trang_thai_danh_gia']),
          reviewer: getV(item, ['reviewer', 'ng∆∞·ªùi_ƒë√°nh_gi√°', 'nguoi_danh_gia', 'ng∆∞·ªùi_review']),
          reviewDate: getV(item, ['reviewDate', 'review_date', 'ng√†y_ƒë√°nh_gi√°', 'ngay_danh_gia']),
          testStatus: getV(item, ['testStatus', 'test_status', 'tr·∫°ng_th√°i_test', 'trang_thai_test']),
          tester: getV(item, ['tester', 'ng∆∞·ªùi_test', 'nguoi_test', 'ng∆∞·ªùi_ki·ªÉm_th·ª≠']),
          testDate: getV(item, ['testDate', 'test_date', 'ng√†y_test', 'ngay_test']),
          deploymentStatus: getV(item, ['deploymentStatus', 'deployment_status', 'tr·∫°ng_th√°i_tri·ªÉn_khai', 'trang_thai_trien_khai']),
          deploymentDate: getV(item, ['deploymentDate', 'deployment_date', 'ng√†y_tri·ªÉn_khai', 'ngay_trien_khai']),
          performance: getV(item, ['performance', 'hi·ªáu_su·∫•t', 'hieu_suat', 'hi·ªáu_qu·∫£', 'hieu_qua']),
          metrics: getV(item, ['metrics', 'ch·ªâ_s·ªë', 'chi_so', 'metric', 'th∆∞·ªõc_ƒëo']),
          kpis: getV(item, ['kpis', 'kpi', 'ch·ªâ_s·ªë_kpi', 'chi_so_kpi']),
          sla: getV(item, ['sla', 'th·ªèa_thu·∫≠n_d·ªãch_v·ª•', 'thoa_thuan_dich_vu']),
          budget: getV(item, ['budget', 'ng√¢n_s√°ch', 'ngan_sach', 'kinh_ph√≠', 'kinh_phi']),
          cost: getV(item, ['cost', 'chi_ph√≠', 'chi_phi', 'gi√°_tr·ªã', 'gia_tri']),
          roi: getV(item, ['roi', 'l·ª£i_nhu·∫≠n_ƒë·∫ßu_t∆∞', 'loi_nhuan_dau_tu', 'hi·ªáu_qu·∫£_ƒë·∫ßu_t∆∞']),
          impact: getV(item, ['impact', 't√°c_ƒë·ªông', 'tac_dong', '·∫£nh_h∆∞·ªüng', 'anh_huong']),
          benefits: getV(item, ['benefits', 'l·ª£i_√≠ch', 'loi_ich', 'l·ª£i_th·∫ø', 'loi_the']),
          challenges: getV(item, ['challenges', 'th√°ch_th·ª©c', 'thach_thuc', 'kh√≥_khƒÉn', 'kho_khan']),
          solutions: getV(item, ['solutions', 'gi·∫£i_ph√°p', 'giai_phap', 'c√°ch_gi·∫£i_quy·∫øt']),
          recommendations: getV(item, ['recommendations', 'khuy·∫øn_ngh·ªã', 'khuyen_nghi', 'ƒë·ªÅ_xu·∫•t', 'de_xuat']),
          
          // L∆∞u raw data ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p ƒë·∫ßy ƒë·ªß
          rawData: item
        });
      });

      // T√≠nh ph·∫ßn trƒÉm cho t·∫•t c·∫£ nh√¢n vi√™n trong danh s√°ch Form 2
      FORM2_NAMES.forEach(name => {
        const stat = F2_EMPLOYEE_STATS[name];
        if (stat) {
          const total = stat.done;
          if (total > 0) {
            stat.aheadPct = ((stat.ahead / total) * 100).toFixed(1);
            stat.ontimePct = ((stat.ontime / total) * 100).toFixed(1);
            stat.latePct = ((stat.late / total) * 100).toFixed(1);
            stat.naPct = ((stat.na / total) * 100).toFixed(1);
          } else {
            stat.aheadPct = "0";
            stat.ontimePct = "0";
            stat.latePct = "0";
            stat.naPct = "0";
          }
        }
      });
      
      console.log('[Form2 Debug] Final F2_EMPLOYEE_STATS:', F2_EMPLOYEE_STATS);
    }

    // T√≠nh to√°n ti·∫øn ƒë·ªô
    function calculateProgress(requestDate, wishDue, completionDate) {
      if (!requestDate || !wishDue || !completionDate) return 'N/A';
      
      // H·ªó tr·ª£ c·∫£ 2 ƒë·ªãnh d·∫°ng: YYYY-MM-DD HH:mm v√† YYYY-MM-DD
      let reqDate, wishDate, compDate;
      
      // Parse requestDate
      if (requestDate.includes(' ')) {
        reqDate = new Date(requestDate);
      } else {
        reqDate = new Date(requestDate + ' 00:00:00');
      }
      
      // Parse wishDue
      if (wishDue.includes(' ')) {
        wishDate = new Date(wishDue);
      } else {
        wishDate = new Date(wishDue + ' 00:00:00');
      }
      
      // Parse completionDate
      if (completionDate.includes(' ')) {
        compDate = new Date(completionDate);
      } else {
        compDate = new Date(completionDate + ' 00:00:00');
      }
      
      if (isNaN(reqDate.getTime()) || isNaN(wishDate.getTime()) || isNaN(compDate.getTime())) {
        return 'N/A';
      }
      
      const daysDiff = (compDate.getTime() - wishDate.getTime()) / (1000 * 60 * 60 * 24);
      
      if (daysDiff < 0) return 'V∆∞·ª£t ti·∫øn ƒë·ªô';
      if (daysDiff <= 1) return 'ƒê√∫ng ti·∫øn ƒë·ªô';
      return 'Ch·∫≠m ti·∫øn ƒë·ªô';
    }

    // Render b·∫£ng th·ªëng k√™
    function renderForm2Stats() {
      const body = document.getElementById('f2-body-p1');
      if (!body) return;

      // Hi·ªÉn th·ªã t·∫•t c·∫£ nh√¢n vi√™n c√≥ trong th·ªëng k√™ (bao g·ªìm t√™n m·ªõi xu·∫•t hi·ªán trong d·ªØ li·ªáu)
      const allNames = Object.keys(F2_EMPLOYEE_STATS);
      if (allNames.length === 0) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
      }

      // ∆Øu ti√™n s·∫Øp x·∫øp: t√™n trong FORM2_NAMES tr∆∞·ªõc, sau ƒë√≥ c√°c t√™n m·ªõi theo alpha
      const preferredSet = new Set(FORM2_NAMES);
      allNames.sort((a,b)=>{
        const aPref = preferredSet.has(a) ? 0 : 1;
        const bPref = preferredSet.has(b) ? 0 : 1;
        if (aPref !== bPref) return aPref - bPref;
        return a.localeCompare(b, 'vi');
      });

      body.innerHTML = '';
      allNames.forEach(name => {
        const stat = F2_EMPLOYEE_STATS[name] || {
          name: name,
          totalTasks: 0,
          done: 0,
          ahead: 0,
          ontime: 0,
          late: 0,
          na: 0,
          aheadPct: "0",
          ontimePct: "0",
          latePct: "0",
          naPct: "0",
          tasks: []
        };
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 font-medium cursor-pointer hover:text-primary-blue" onclick="openF2P1DetailModal('${stat.name}')">${stat.name}</td>
          <td class="px-3 py-2 text-center font-semibold text-blue-600">${stat.totalTasks}</td>
          <td class="px-3 py-2 text-center">${stat.done}</td>
          <td class="px-3 py-2 text-center text-green-600">${stat.ahead}</td>
          <td class="px-3 py-2 text-center text-blue-600">${stat.ontime}</td>
          <td class="px-3 py-2 text-center text-red-600">${stat.late}</td>
          <td class="px-3 py-2 text-center text-gray-600">${stat.na}</td>
          <td class="px-3 py-2 text-center text-green-600">${stat.aheadPct || 0}%</td>
          <td class="px-3 py-2 text-center text-blue-600">${stat.ontimePct || 0}%</td>
          <td class="px-3 py-2 text-center text-red-600">${stat.latePct || 0}%</td>
          <td class="px-3 py-2 text-center text-gray-600">${stat.naPct || 0}%</td>
        `;
        body.appendChild(tr);
      });
    }

    // Form 2: Render panel data (legacy function - now calls fetchForm2Data)
    function renderForm2Panel(panelId) {
      if (panelId === 'p1') {
        fetchForm2Data();
      }
    }

    // Form 2: Search button event listeners
    document.querySelectorAll('[id^="f2-search-"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const panelId = btn.id.replace('f2-search-', '');
        
        // Show loading state
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        
        // Simulate API call
        setTimeout(() => {
          renderForm2Panel(panelId);
          btn.disabled = false;
          btn.textContent = originalText;
          showToast(`ƒê√£ t·∫£i d·ªØ li·ªáu ${panelId.toUpperCase()}.`, 'success');
        }, 1000);
      });
    });

    // Form 2: Export functionality
    const f2ExportBtn = document.getElementById('f2-export');
    const f2ExportXlsxBtn = document.getElementById('f2-export-xlsx');
    
    if (f2ExportBtn) {
      f2ExportBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showToast('Ch·ª©c nƒÉng xu·∫•t server ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
      });
    }
    
    if (f2ExportXlsxBtn) {
      f2ExportXlsxBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showToast('Ch·ª©c nƒÉng xu·∫•t XLSX ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
      });
    }

    // Form 2: Modal functions
    function openF2P1DetailModal(employeeName) {
      const modal = document.getElementById('f2-p1-detail-modal');
      const nameSpan = document.getElementById('f2-p1-detail-name');
      const body = document.getElementById('f2-p1-detail-body');
      
      if (nameSpan) nameSpan.textContent = employeeName;
      
      // L·∫•y d·ªØ li·ªáu th·ª±c t·ª´ F2_EMPLOYEE_STATS
      const employeeData = F2_EMPLOYEE_STATS[employeeName];
      
      if (!employeeData || !employeeData.tasks || employeeData.tasks.length === 0) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Kh√¥ng c√≥ d·ªØ li·ªáu t√°c v·ª•</td></tr>';
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        return;
      }
      
      // L·ªçc: ch·ªâ hi·ªÉn th·ªã c√°c t√°c v·ª• ƒë∆∞·ª£c ƒë·∫øm
      // - Lu√¥n g·ªìm c√°c t√°c v·ª• Doing (ƒë∆∞·ª£c t√≠nh v√†o totalTasks)
      // - V√† c√°c t√°c v·ª• Done c√≥ completionDate n·∫±m trong F2_MONTH_FILTER (n·∫øu ƒëang l·ªçc th√°ng)
      // - N·∫øu kh√¥ng l·ªçc th√°ng, hi·ªÉn th·ªã Doing v√† t·∫•t c·∫£ Done c√≥ completionDate
      const filtered = (employeeData.tasks || []).filter(task => {
        const statusLower = String(task.status || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('ƒëang');
        const isDone = statusLower.includes('ho√†n') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('h·ªßy') || statusLower.includes('hu·ª∑');
        if (isCancelled) return false;
        if (isDoing) return true;
        if (!isDone) return false;
        const comp = task.completionDate;
        if (!comp) return false;
        const compDate = parseDateFlexible(comp);
        if (isNaN(compDate.getTime())) return false;
        if (F2_MONTH_FILTER) {
          const ym = `${compDate.getFullYear()}-${String(compDate.getMonth()+1).padStart(2,'0')}`;
          return ym === F2_MONTH_FILTER;
        }
        return true;
      });

      // S·∫Øp x·∫øp: Doing tr√™n, Done ph√≠a d∆∞·ªõi (gi·ªØ nguy√™n th·ª© t·ª± b√™n trong m·ªói nh√≥m)
      const sorted = filtered.sort((a,b)=>{
        const aStatus = String(a.status||'').toLowerCase();
        const bStatus = String(b.status||'').toLowerCase();
        const aDoing = aStatus.includes('doing') || aStatus.includes('ƒëang');
        const bDoing = bStatus.includes('doing') || bStatus.includes('ƒëang');
        if (aDoing && !bDoing) return -1;
        if (!aDoing && bDoing) return 1;
        return 0;
      });

      body.innerHTML = '';
      sorted.forEach((task) => {
        const tr = document.createElement('tr');
        
        // T·∫°o badge tr·∫°ng th√°i
        const statusLower = (task.status || '').toLowerCase();
        const isDone = statusLower.includes('ho√†n') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('h·ªßy') || statusLower.includes('hu·ª∑');
        const statusBadge = `<span class="px-2 py-1 rounded text-xs ${isDone ? 'bg-green-100 text-green-800' : (isCancelled || statusLower.includes('ch·ªù') || statusLower.includes('pending')) ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${task.status || ''}</span>`;
        
        tr.innerHTML = `
          <td class="px-3 py-2">${statusBadge}</td>
          <td class="px-3 py-2">${task.completionDate || '-'}</td>
          <td class="px-3 py-2">${task.code || '-'}</td>
          <td class="px-3 py-2">${task.taskName || '-'}</td>
          <td class="px-3 py-2">${task.requester || '-'}</td>
          <td class="px-3 py-2">${task.requestDate || '-'}</td>
          <td class="px-3 py-2">${task.wishDue || '-'}</td>
          <td class="px-3 py-2">${task.note || '-'}</td>
        `;
        body.appendChild(tr);
      });
      
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeF2P1DetailModal() {
      const modal = document.getElementById('f2-p1-detail-modal');
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }

    // Form 2: Modal event listeners
    const f2P1DetailCloseBtn = document.getElementById('f2-p1-detail-close');
    if (f2P1DetailCloseBtn) {
      f2P1DetailCloseBtn.addEventListener('click', closeF2P1DetailModal);
    }

    const f2P1DetailModal = document.getElementById('f2-p1-detail-modal');
    if (f2P1DetailModal) {
      f2P1DetailModal.addEventListener('click', (e) => {
        if (e.target === f2P1DetailModal) closeF2P1DetailModal();
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && f2P1DetailModal.classList.contains('open')) {
        closeF2P1DetailModal();
      }
    });

    // Initialize Form 2 with P1
    setTimeout(() => {
      fetchForm2Data();
    }, 100);


  </script>
</body>
</html>








